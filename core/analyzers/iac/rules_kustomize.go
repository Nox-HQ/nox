package iac

import (
	"github.com/nox-hq/nox/core/findings"
	"github.com/nox-hq/nox/core/rules"
)

// builtinKustomizeRules returns built-in Kustomize security rules (IAC-231 to IAC-245).
func builtinKustomizeRules() []rules.Rule {
	kustomizeFilePatterns := []string{"kustomization.yaml", "kustomization.yml", "*.yaml", "*.yml"}

	defs := []iacRule{
		{
			id: "IAC-231", severity: findings.SeverityMedium, confidence: findings.ConfidenceMedium,
			pattern:      `(?i)image:.*:latest\b`,
			description:  "Kustomize uses latest image tag",
			cwe:          "CWE-829",
			keywords:     []string{"image", "latest"},
			filePatterns: kustomizeFilePatterns,
			tags:         []string{"iac", "kustomize", "supply-chain"},
			remediation:  "Pin container images to a specific version tag or digest instead of using 'latest'. Mutable tags can silently change the deployed image, leading to reproducibility and supply chain issues.",
			references:   []string{"https://cwe.mitre.org/data/definitions/829.html"},
		},
		{
			id: "IAC-232", severity: findings.SeverityMedium, confidence: findings.ConfidenceHigh,
			pattern:      `(?i)namespace:\s*['"]?default['"]?`,
			description:  "Kustomize deploys to default namespace",
			cwe:          "CWE-693",
			keywords:     []string{"namespace", "default"},
			filePatterns: kustomizeFilePatterns,
			tags:         []string{"iac", "kustomize", "best-practice"},
			remediation:  "Use a dedicated namespace instead of 'default'. The default namespace lacks isolation and makes it harder to apply RBAC policies and resource quotas.",
			references:   []string{"https://cwe.mitre.org/data/definitions/693.html"},
		},
		{
			id: "IAC-233", severity: findings.SeverityHigh, confidence: findings.ConfidenceMedium,
			pattern:      `(?i)resources:\s*\n(?:\s*-\s*https?://)`,
			description:  "Kustomize remote resource without pin",
			cwe:          "CWE-829",
			keywords:     []string{"resources", "http"},
			filePatterns: kustomizeFilePatterns,
			tags:         []string{"iac", "kustomize", "supply-chain"},
			remediation:  "Pin remote resources to a specific Git ref or tag (e.g., '?ref=v1.2.3'). Unpinned remote resources can change without notice, introducing supply chain risk.",
			references:   []string{"https://cwe.mitre.org/data/definitions/829.html"},
		},
		{
			id: "IAC-234", severity: findings.SeverityHigh, confidence: findings.ConfidenceMedium,
			pattern:      `(?i)bases:\s*\n(?:\s*-\s*https?://)`,
			description:  "Kustomize remote base without version pin",
			cwe:          "CWE-829",
			keywords:     []string{"bases", "http"},
			filePatterns: kustomizeFilePatterns,
			tags:         []string{"iac", "kustomize", "supply-chain"},
			remediation:  "Pin remote bases to a specific Git ref or tag (e.g., '?ref=v1.2.3'). Additionally, consider migrating from 'bases' to 'resources' as 'bases' is deprecated.",
			references:   []string{"https://cwe.mitre.org/data/definitions/829.html"},
		},
		{
			id: "IAC-235", severity: findings.SeverityHigh, confidence: findings.ConfidenceMedium,
			pattern:      `(?i)literals:\s*\n\s*-\s*\w+=`,
			description:  "Kustomize secretGenerator with inline literals",
			cwe:          "CWE-798",
			keywords:     []string{"secretGenerator", "literals"},
			filePatterns: kustomizeFilePatterns,
			tags:         []string{"iac", "kustomize", "secrets"},
			remediation:  "Use 'envs' or 'files' in secretGenerator to reference external secret sources instead of inline literals. Inline secrets are stored in plain text in version control.",
			references:   []string{"https://cwe.mitre.org/data/definitions/798.html"},
		},
		{
			id: "IAC-236", severity: findings.SeverityHigh, confidence: findings.ConfidenceLow,
			pattern:      `(?i)(?:password|secret|token|key)\s*=\s*[A-Za-z0-9]`,
			description:  "Kustomize configMap with hardcoded secret",
			cwe:          "CWE-798",
			keywords:     []string{"configMapGenerator", "password", "secret"},
			filePatterns: []string{"kustomization.yaml", "kustomization.yml"},
			tags:         []string{"iac", "kustomize", "secrets"},
			remediation:  "Move sensitive values from configMapGenerator to secretGenerator and use external secret management (e.g., Sealed Secrets, SOPS, or an external secrets operator).",
			references:   []string{"https://cwe.mitre.org/data/definitions/798.html"},
		},
		{
			id: "IAC-237", severity: findings.SeverityHigh, confidence: findings.ConfidenceMedium,
			pattern:      `(?i)privileged:\s*true`,
			description:  "Kustomize patch enables privileged containers",
			cwe:          "CWE-250",
			keywords:     []string{"privileged"},
			filePatterns: kustomizeFilePatterns,
			tags:         []string{"iac", "kustomize", "privilege"},
			remediation:  "Avoid running containers in privileged mode. Use specific Linux capabilities (securityContext.capabilities.add) instead of granting full host access.",
			references:   []string{"https://cwe.mitre.org/data/definitions/250.html"},
		},
		{
			id: "IAC-238", severity: findings.SeverityLow, confidence: findings.ConfidenceLow,
			pattern:      `(?i)count:\s*1\b`,
			description:  "Kustomize sets replica count to 1 (no HA)",
			cwe:          "CWE-693",
			keywords:     []string{"replicas", "count"},
			filePatterns: kustomizeFilePatterns,
			tags:         []string{"iac", "kustomize", "availability"},
			remediation:  "Consider setting replica count to at least 2 for production workloads to ensure high availability and fault tolerance during rolling updates or node failures.",
			references:   []string{"https://cwe.mitre.org/data/definitions/693.html"},
		},
		{
			id: "IAC-239", severity: findings.SeverityLow, confidence: findings.ConfidenceLow,
			pattern:      `(?i)commonLabels:\s*$`,
			description:  "Kustomize commonLabels missing standard labels",
			cwe:          "CWE-693",
			keywords:     []string{"commonLabels"},
			filePatterns: kustomizeFilePatterns,
			tags:         []string{"iac", "kustomize", "best-practice"},
			remediation:  "Include recommended Kubernetes labels (app.kubernetes.io/name, app.kubernetes.io/version, app.kubernetes.io/managed-by) in commonLabels for consistent resource identification.",
			references:   []string{"https://cwe.mitre.org/data/definitions/693.html"},
		},
		{
			id: "IAC-240", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:      `(?i)helmCharts:\s*\n\s*-\s*name:`,
			description:  "Kustomize helm chart reference (verify version pin)",
			cwe:          "CWE-829",
			keywords:     []string{"helmCharts"},
			filePatterns: kustomizeFilePatterns,
			tags:         []string{"iac", "kustomize", "supply-chain"},
			remediation:  "Always specify an explicit 'version' field for Helm chart references in Kustomize. Unpinned chart versions may introduce unexpected changes or vulnerabilities.",
			references:   []string{"https://cwe.mitre.org/data/definitions/829.html"},
		},
		{
			id: "IAC-241", severity: findings.SeverityLow, confidence: findings.ConfidenceHigh,
			pattern:      `(?i)generatorOptions:\s*\n\s*disableNameSuffixHash:\s*true`,
			description:  "Kustomize disables name suffix hash",
			cwe:          "CWE-693",
			keywords:     []string{"disableNameSuffixHash"},
			filePatterns: kustomizeFilePatterns,
			tags:         []string{"iac", "kustomize", "best-practice"},
			remediation:  "Keep name suffix hashing enabled. The hash suffix triggers rolling updates when ConfigMap or Secret content changes, preventing stale configuration in running pods.",
			references:   []string{"https://cwe.mitre.org/data/definitions/693.html"},
		},
		{
			id: "IAC-242", severity: findings.SeverityMedium, confidence: findings.ConfidenceMedium,
			pattern:      `(?i)resources:\s*\n\s*-\s*\.\.`,
			description:  "Kustomize references parent directory resources",
			cwe:          "CWE-22",
			keywords:     []string{"resources", ".."},
			filePatterns: kustomizeFilePatterns,
			tags:         []string{"iac", "kustomize", "best-practice"},
			remediation:  "Avoid parent directory traversal in resource references. Use explicit overlay/base directory structures to maintain clear dependency boundaries and prevent path traversal issues.",
			references:   []string{"https://cwe.mitre.org/data/definitions/22.html"},
		},
		{
			id: "IAC-243", severity: findings.SeverityLow, confidence: findings.ConfidenceMedium,
			pattern:      `(?i)vars:\s*\n`,
			description:  "Kustomize uses deprecated vars feature",
			cwe:          "CWE-693",
			keywords:     []string{"vars"},
			filePatterns: kustomizeFilePatterns,
			tags:         []string{"iac", "kustomize", "best-practice"},
			remediation:  "Migrate from deprecated 'vars' to 'replacements' for value substitution. The vars feature is deprecated and will be removed in a future Kustomize version.",
			references:   []string{"https://cwe.mitre.org/data/definitions/693.html"},
		},
		{
			id: "IAC-244", severity: findings.SeverityMedium, confidence: findings.ConfidenceHigh,
			pattern:      `(?i)images:\s*\n\s*-\s*name:.*\n\s*newTag:\s*['"]?latest`,
			description:  "Kustomize image override uses latest tag",
			cwe:          "CWE-829",
			keywords:     []string{"newTag", "latest"},
			filePatterns: kustomizeFilePatterns,
			tags:         []string{"iac", "kustomize", "supply-chain"},
			remediation:  "Use a specific version tag or image digest in the 'newTag' field instead of 'latest'. Mutable tags break reproducibility and make rollbacks unreliable.",
			references:   []string{"https://cwe.mitre.org/data/definitions/829.html"},
		},
		{
			id: "IAC-245", severity: findings.SeverityLow, confidence: findings.ConfidenceLow,
			pattern:      `(?i)op:\s*['"]?remove['"]?`,
			description:  "Kustomize JSON patch removes fields (verify intent)",
			cwe:          "CWE-693",
			keywords:     []string{"patchesJson6902", "remove"},
			filePatterns: kustomizeFilePatterns,
			tags:         []string{"iac", "kustomize", "best-practice"},
			remediation:  "Review JSON6902 remove operations carefully. Removing fields like security contexts, resource limits, or network policies can weaken the security posture of workloads.",
			references:   []string{"https://cwe.mitre.org/data/definitions/693.html"},
		},
	}

	out := make([]rules.Rule, len(defs))
	for i := range defs {
		out[i] = rules.Rule{
			ID:           defs[i].id,
			Version:      "1.0",
			Description:  defs[i].description,
			Severity:     defs[i].severity,
			Confidence:   defs[i].confidence,
			MatcherType:  "regex",
			Pattern:      defs[i].pattern,
			FilePatterns: defs[i].filePatterns,
			Keywords:     defs[i].keywords,
			Tags:         defs[i].tags,
			Metadata:     map[string]string{"cwe": defs[i].cwe},
			Remediation:  defs[i].remediation,
			References:   defs[i].references,
		}
	}
	return out
}

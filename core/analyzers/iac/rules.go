package iac

import (
	"github.com/nox-hq/nox/core/findings"
	"github.com/nox-hq/nox/core/rules"
)

// iacRule is a compact representation used to define built-in IaC security rules
// in a table. Each entry is converted to a rules.Rule by builtinIaCRules().
type iacRule struct {
	id           string
	severity     findings.Severity
	confidence   findings.Confidence
	pattern      string
	description  string
	cwe          string
	keywords     []string
	filePatterns []string
	tags         []string
	remediation  string
	references   []string
}

// builtinBaseIaCRules returns the original set of IaC security rules (IAC-001 to IAC-185).
func builtinBaseIaCRules() []rules.Rule {
	defs := []iacRule{
		// =================================================================
		// Dockerfile rules (IAC-001 to IAC-003, IAC-022 to IAC-025)
		// =================================================================
		{
			id: "IAC-001", severity: findings.SeverityHigh, confidence: findings.ConfidenceMedium,
			pattern:     `(?im)^\s*USER\s+root\s*$`,
			description: "Dockerfile runs as root user",
			cwe:         "CWE-250", keywords: []string{"user root"},
			filePatterns: []string{"Dockerfile", "Dockerfile.*", "*.dockerfile"},
			tags:         []string{"iac", "docker", "privilege"},
			remediation:  "Create a non-root user and switch to it with USER directive. Example: RUN adduser --disabled-password appuser && USER appuser.",
			references:   []string{"https://cwe.mitre.org/data/definitions/250.html", "https://docs.docker.com/develop/develop-images/dockerfile_best-practices/#user"},
		},
		{
			id: "IAC-002", severity: findings.SeverityMedium, confidence: findings.ConfidenceMedium,
			pattern:     `(?im)^\s*FROM\s+[a-zA-Z0-9._/-]+\s*$|(?im)^\s*FROM\s+\S+:latest\b`,
			description: "Dockerfile uses unpinned base image (latest or no tag)",
			cwe:         "CWE-829", keywords: []string{"from"},
			filePatterns: []string{"Dockerfile", "Dockerfile.*", "*.dockerfile"},
			tags:         []string{"iac", "docker", "supply-chain"},
			remediation:  "Pin base images to a specific version and digest (e.g., 'node:20-alpine@sha256:abc...'). This ensures reproducible builds and protects against supply chain attacks.",
			references:   []string{"https://cwe.mitre.org/data/definitions/829.html"},
		},
		{
			id: "IAC-003", severity: findings.SeverityLow, confidence: findings.ConfidenceHigh,
			pattern:     `(?im)^\s*ADD\s+`,
			description: "Dockerfile uses ADD instead of COPY",
			cwe:         "CWE-829", keywords: []string{"add"},
			filePatterns: []string{"Dockerfile", "Dockerfile.*", "*.dockerfile"},
			tags:         []string{"iac", "docker", "best-practice"},
			remediation:  "Use COPY instead of ADD for local file copying. ADD has implicit tar extraction and remote URL support that can introduce unexpected behaviour.",
			references:   []string{"https://docs.docker.com/develop/develop-images/dockerfile_best-practices/#add-or-copy"},
		},
		{
			id: "IAC-022", severity: findings.SeverityHigh, confidence: findings.ConfidenceMedium,
			pattern:     `(?im)^\s*ARG\s+(PASSWORD|SECRET|TOKEN|API_KEY|PRIVATE_KEY|DB_PASS|MYSQL_PASSWORD|POSTGRES_PASSWORD)\b`,
			description: "Secret value passed as Docker build argument",
			cwe:         "CWE-798", keywords: []string{"arg"},
			filePatterns: []string{"Dockerfile", "Dockerfile.*", "*.dockerfile"},
			tags:         []string{"iac", "docker", "secrets"},
			remediation:  "Use Docker BuildKit secrets (--mount=type=secret) instead of ARG for sensitive values. Build arguments are visible in image history and layer metadata.",
			references:   []string{"https://cwe.mitre.org/data/definitions/798.html", "https://docs.docker.com/build/building/secrets/"},
		},
		{
			id: "IAC-023", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)curl\s+[^|]*\|\s*(sh|bash|zsh)|wget\s+[^|]*\|\s*(sh|bash|zsh)`,
			description: "Remote script piped directly to shell",
			cwe:         "CWE-94", keywords: []string{"curl", "wget"},
			filePatterns: []string{"Dockerfile", "Dockerfile.*", "*.dockerfile"},
			tags:         []string{"iac", "docker", "supply-chain"},
			remediation:  "Download scripts to a file first, verify their checksum, then execute. Piping from curl to shell skips integrity checks and risks executing tampered content.",
			references:   []string{"https://cwe.mitre.org/data/definitions/94.html"},
		},
		{
			id: "IAC-024", severity: findings.SeverityMedium, confidence: findings.ConfidenceMedium,
			pattern:     `(?im)^\s*RUN\s+.*\bsudo\b`,
			description: "Dockerfile RUN uses sudo (unnecessary in Docker build)",
			cwe:         "CWE-250", keywords: []string{"sudo"},
			filePatterns: []string{"Dockerfile", "Dockerfile.*", "*.dockerfile"},
			tags:         []string{"iac", "docker", "privilege"},
			remediation:  "Remove sudo from RUN commands. Docker builds run as root by default. Use USER to switch to a non-root user after installation steps.",
			references:   []string{"https://cwe.mitre.org/data/definitions/250.html"},
		},
		{
			id: "IAC-025", severity: findings.SeverityMedium, confidence: findings.ConfidenceHigh,
			pattern:     `(?im)^\s*(COPY|ADD)\s+--chmod=777\b`,
			description: "Dockerfile COPY/ADD sets world-writable permissions",
			cwe:         "CWE-732", keywords: []string{"chmod=777"},
			filePatterns: []string{"Dockerfile", "Dockerfile.*", "*.dockerfile"},
			tags:         []string{"iac", "docker", "permissions"},
			remediation:  "Use restrictive file permissions (e.g., --chmod=755 or --chmod=644). World-writable files allow any process in the container to modify them.",
			references:   []string{"https://cwe.mitre.org/data/definitions/732.html"},
		},

		// =================================================================
		// Terraform / Cloud rules (IAC-004 to IAC-006, IAC-036 to IAC-045)
		// =================================================================
		{
			id: "IAC-004", severity: findings.SeverityHigh, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)(cidr_blocks|ingress_cidr|source_ranges)\s*=\s*\[?\s*"0\.0\.0\.0/0"`,
			description: "Terraform resource allows public access (0.0.0.0/0)",
			cwe:         "CWE-284", keywords: []string{"0.0.0.0/0"},
			filePatterns: []string{"*.tf", "*.tfvars"},
			tags:         []string{"iac", "terraform", "network"},
			remediation:  "Restrict CIDR blocks to specific IP ranges or VPC subnets instead of 0.0.0.0/0. Use security groups and NACLs for defense in depth.",
			references:   []string{"https://cwe.mitre.org/data/definitions/284.html"},
		},
		{
			id: "IAC-005", severity: findings.SeverityHigh, confidence: findings.ConfidenceLow,
			pattern:     `(?i)encrypt\w*\s*=\s*(false|"false")`,
			description: "Terraform resource has encryption disabled",
			cwe:         "CWE-311", keywords: []string{"encrypt"},
			filePatterns: []string{"*.tf", "*.tfvars"},
			tags:         []string{"iac", "terraform", "encryption"},
			remediation:  "Enable server-side encryption on all storage resources. Use aws_s3_bucket_server_side_encryption_configuration with AES-256 or AWS KMS.",
			references:   []string{"https://cwe.mitre.org/data/definitions/311.html", "https://docs.aws.amazon.com/AmazonS3/latest/userguide/bucket-encryption.html"},
		},
		{
			id: "IAC-006", severity: findings.SeverityCritical, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)(from_port|to_port)\s*=\s*22`,
			description: "Terraform security group allows SSH access (port 22)",
			cwe:         "CWE-284", keywords: []string{"from_port", "to_port"},
			filePatterns: []string{"*.tf"},
			tags:         []string{"iac", "terraform", "network"},
			remediation:  "Restrict SSH access to specific CIDR blocks or use AWS Systems Manager Session Manager instead of direct SSH. Never combine port 22 with 0.0.0.0/0.",
			references:   []string{"https://cwe.mitre.org/data/definitions/284.html"},
		},
		{
			id: "IAC-036", severity: findings.SeverityCritical, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)publicly_accessible\s*=\s*true`,
			description: "RDS or database instance is publicly accessible",
			cwe:         "CWE-284", keywords: []string{"publicly_accessible"},
			filePatterns: []string{"*.tf", "*.tfvars"},
			tags:         []string{"iac", "terraform", "database", "network"},
			remediation:  "Set publicly_accessible = false and access the database through a VPC, bastion host, or VPN. Public database instances are a common attack vector.",
			references:   []string{"https://cwe.mitre.org/data/definitions/284.html"},
		},
		{
			id: "IAC-037", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)storage_encrypted\s*=\s*false`,
			description: "RDS storage encryption disabled",
			cwe:         "CWE-311", keywords: []string{"storage_encrypted"},
			filePatterns: []string{"*.tf", "*.tfvars"},
			tags:         []string{"iac", "terraform", "database", "encryption"},
			remediation:  "Set storage_encrypted = true on RDS instances. Enable encryption at rest to protect sensitive data from unauthorized access to underlying storage.",
			references:   []string{"https://cwe.mitre.org/data/definitions/311.html"},
		},
		{
			id: "IAC-038", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)is_multi_region_trail\s*=\s*false`,
			description: "CloudTrail multi-region logging disabled",
			cwe:         "CWE-778", keywords: []string{"is_multi_region_trail"},
			filePatterns: []string{"*.tf"},
			tags:         []string{"iac", "terraform", "logging", "aws"},
			remediation:  "Set is_multi_region_trail = true to ensure CloudTrail captures API activity across all AWS regions. Single-region trails miss activity in other regions.",
			references:   []string{"https://cwe.mitre.org/data/definitions/778.html"},
		},
		{
			id: "IAC-039", severity: findings.SeverityCritical, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)("Action"\s*:\s*\[?\s*"\*"\s*\]?|actions\s*=\s*\[\s*"\*"\s*\])`,
			description: "IAM policy with wildcard action (*)",
			cwe:         "CWE-269", keywords: []string{"action", "actions"},
			filePatterns: []string{"*.tf", "*.json"},
			tags:         []string{"iac", "terraform", "iam", "privilege"},
			remediation:  "Follow the principle of least privilege. Replace wildcard actions with specific API actions required for the workload (e.g., 's3:GetObject' instead of '*').",
			references:   []string{"https://cwe.mitre.org/data/definitions/269.html"},
		},
		{
			id: "IAC-040", severity: findings.SeverityCritical, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)acl\s*=\s*["'](public-read|public-read-write)["']`,
			description: "S3 bucket with public ACL",
			cwe:         "CWE-284", keywords: []string{"public-read"},
			filePatterns: []string{"*.tf", "*.tfvars"},
			tags:         []string{"iac", "terraform", "s3", "network"},
			remediation:  "Use acl = 'private' and S3 Block Public Access settings. Grant access via IAM policies and pre-signed URLs instead of public ACLs.",
			references:   []string{"https://cwe.mitre.org/data/definitions/284.html"},
		},
		{
			id: "IAC-041", severity: findings.SeverityHigh, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)protocol\s*=\s*["']HTTP["']`,
			description: "Load balancer listener uses HTTP instead of HTTPS",
			cwe:         "CWE-319", keywords: []string{"protocol"},
			filePatterns: []string{"*.tf"},
			tags:         []string{"iac", "terraform", "network", "encryption"},
			remediation:  "Use HTTPS (TLS) for all load balancer listeners. Configure an ACM certificate and redirect HTTP to HTTPS to protect data in transit.",
			references:   []string{"https://cwe.mitre.org/data/definitions/319.html"},
		},
		{
			id: "IAC-042", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)enable_https_traffic_only\s*=\s*false`,
			description: "Azure storage account allows HTTP traffic",
			cwe:         "CWE-319", keywords: []string{"enable_https_traffic_only"},
			filePatterns: []string{"*.tf"},
			tags:         []string{"iac", "terraform", "azure", "encryption"},
			remediation:  "Set enable_https_traffic_only = true to enforce HTTPS on Azure storage accounts. HTTP traffic exposes data to eavesdropping and tampering.",
			references:   []string{"https://cwe.mitre.org/data/definitions/319.html"},
		},
		{
			id: "IAC-043", severity: findings.SeverityHigh, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)protocol\s*=\s*["']all["']`,
			description: "Cloud firewall rule allows all protocols",
			cwe:         "CWE-284", keywords: []string{"protocol"},
			filePatterns: []string{"*.tf"},
			tags:         []string{"iac", "terraform", "network", "gcp"},
			remediation:  "Restrict firewall rules to specific protocols (tcp, udp) and ports. Allowing all protocols creates an overly permissive network configuration.",
			references:   []string{"https://cwe.mitre.org/data/definitions/284.html"},
		},
		{
			id: "IAC-044", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)default_vpc|aws_default_vpc|aws_default_subnet`,
			description: "Terraform resource uses default VPC",
			cwe:         "CWE-1188", keywords: []string{"default_vpc", "aws_default"},
			filePatterns: []string{"*.tf"},
			tags:         []string{"iac", "terraform", "network", "aws"},
			remediation:  "Create dedicated VPCs with proper subnet design instead of using default VPCs. Default VPCs have permissive security settings not suitable for production.",
			references:   []string{"https://cwe.mitre.org/data/definitions/1188.html"},
		},
		{
			id: "IAC-045", severity: findings.SeverityHigh, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)log_status\s*=\s*["']disabled["']|logging_service\s*=\s*["']none["']`,
			description: "Cloud resource logging disabled",
			cwe:         "CWE-778", keywords: []string{"log_status", "logging_service"},
			filePatterns: []string{"*.tf"},
			tags:         []string{"iac", "terraform", "logging"},
			remediation:  "Enable logging on all cloud resources. Audit logs are essential for security monitoring, incident response, and compliance.",
			references:   []string{"https://cwe.mitre.org/data/definitions/778.html"},
		},

		// =================================================================
		// Kubernetes rules (IAC-007 to IAC-010, IAC-026 to IAC-035)
		// =================================================================
		{
			id: "IAC-007", severity: findings.SeverityCritical, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)privileged\s*:\s*true`,
			description: "Kubernetes pod running as privileged",
			cwe:         "CWE-250", keywords: []string{"privileged"},
			filePatterns: []string{"*.yaml", "*.yml"},
			tags:         []string{"iac", "kubernetes", "privilege"},
			remediation:  "Set privileged: false in the pod security context. Use specific capabilities (add/drop) instead of full privilege. Apply Pod Security Standards.",
			references:   []string{"https://cwe.mitre.org/data/definitions/250.html", "https://kubernetes.io/docs/concepts/security/pod-security-standards/"},
		},
		{
			id: "IAC-008", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)hostNetwork\s*:\s*true`,
			description: "Kubernetes pod uses host network",
			cwe:         "CWE-284", keywords: []string{"hostnetwork"},
			filePatterns: []string{"*.yaml", "*.yml"},
			tags:         []string{"iac", "kubernetes", "network"},
			remediation:  "Remove hostNetwork: true and use Kubernetes Services and NetworkPolicies for pod communication. Host networking bypasses network isolation.",
			references:   []string{"https://cwe.mitre.org/data/definitions/284.html", "https://kubernetes.io/docs/concepts/services-networking/network-policies/"},
		},
		{
			id: "IAC-009", severity: findings.SeverityCritical, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)allowPrivilegeEscalation\s*:\s*true`,
			description: "Kubernetes pod allows privilege escalation",
			cwe:         "CWE-250", keywords: []string{"allowprivilegeescalation"},
			filePatterns: []string{"*.yaml", "*.yml"},
			tags:         []string{"iac", "kubernetes", "privilege"},
			remediation:  "Set allowPrivilegeEscalation: false in the container security context. This prevents child processes from gaining more privileges than the parent.",
			references:   []string{"https://cwe.mitre.org/data/definitions/250.html", "https://kubernetes.io/docs/concepts/security/pod-security-standards/"},
		},
		{
			id: "IAC-010", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?im)runAsUser\s*:\s*0\s*$`,
			description: "Kubernetes pod running as root (runAsUser: 0)",
			cwe:         "CWE-250", keywords: []string{"runasuser"},
			filePatterns: []string{"*.yaml", "*.yml"},
			tags:         []string{"iac", "kubernetes", "privilege"},
			remediation:  "Set runAsUser to a non-zero UID (e.g., 1000) and runAsNonRoot: true in the pod security context. Build container images to run as non-root.",
			references:   []string{"https://cwe.mitre.org/data/definitions/250.html"},
		},
		{
			id: "IAC-026", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)hostPID\s*:\s*true`,
			description: "Kubernetes pod uses host PID namespace",
			cwe:         "CWE-250", keywords: []string{"hostpid"},
			filePatterns: []string{"*.yaml", "*.yml"},
			tags:         []string{"iac", "kubernetes", "privilege"},
			remediation:  "Remove hostPID: true. Sharing the host PID namespace allows the container to see and signal all processes on the host, breaking process isolation.",
			references:   []string{"https://cwe.mitre.org/data/definitions/250.html"},
		},
		{
			id: "IAC-027", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)hostIPC\s*:\s*true`,
			description: "Kubernetes pod uses host IPC namespace",
			cwe:         "CWE-250", keywords: []string{"hostipc"},
			filePatterns: []string{"*.yaml", "*.yml"},
			tags:         []string{"iac", "kubernetes", "privilege"},
			remediation:  "Remove hostIPC: true. Sharing the host IPC namespace allows containers to access shared memory and IPC resources of other host processes.",
			references:   []string{"https://cwe.mitre.org/data/definitions/250.html"},
		},
		{
			id: "IAC-028", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?im)^\s*-\s*(SYS_ADMIN|SYS_PTRACE|NET_RAW|SYS_MODULE|DAC_OVERRIDE)\s*$`,
			description: "Container adds dangerous Linux capability",
			cwe:         "CWE-250", keywords: []string{"sys_admin", "sys_ptrace", "net_raw"},
			filePatterns: []string{"*.yaml", "*.yml"},
			tags:         []string{"iac", "kubernetes", "privilege", "capabilities"},
			remediation:  "Drop all capabilities and add only those specifically needed. Dangerous capabilities like SYS_ADMIN, NET_RAW, and SYS_PTRACE break container isolation.",
			references:   []string{"https://cwe.mitre.org/data/definitions/250.html", "https://kubernetes.io/docs/concepts/security/pod-security-standards/"},
		},
		{
			id: "IAC-029", severity: findings.SeverityMedium, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)readOnlyRootFilesystem\s*:\s*false`,
			description: "Container root filesystem is writable",
			cwe:         "CWE-732", keywords: []string{"readonlyrootfilesystem"},
			filePatterns: []string{"*.yaml", "*.yml"},
			tags:         []string{"iac", "kubernetes", "filesystem"},
			remediation:  "Set readOnlyRootFilesystem: true and use emptyDir or tmpfs volumes for writable directories. This prevents attackers from modifying container binaries.",
			references:   []string{"https://cwe.mitre.org/data/definitions/732.html"},
		},
		{
			id: "IAC-030", severity: findings.SeverityMedium, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)automountServiceAccountToken\s*:\s*true`,
			description: "Service account token automatically mounted",
			cwe:         "CWE-269", keywords: []string{"automountserviceaccounttoken"},
			filePatterns: []string{"*.yaml", "*.yml"},
			tags:         []string{"iac", "kubernetes", "privilege"},
			remediation:  "Set automountServiceAccountToken: false unless the pod requires Kubernetes API access. Mounted tokens can be used for lateral movement if the pod is compromised.",
			references:   []string{"https://cwe.mitre.org/data/definitions/269.html"},
		},
		{
			id: "IAC-031", severity: findings.SeverityMedium, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)image\s*:\s*["']?[a-zA-Z0-9._/-]+:latest["']?\s*$`,
			description: "Container image uses latest tag in Kubernetes manifest",
			cwe:         "CWE-829", keywords: []string{":latest"},
			filePatterns: []string{"*.yaml", "*.yml"},
			tags:         []string{"iac", "kubernetes", "supply-chain"},
			remediation:  "Pin container images to specific versions or digests (e.g., 'nginx:1.25@sha256:abc...'). The latest tag is mutable and can silently introduce breaking changes.",
			references:   []string{"https://cwe.mitre.org/data/definitions/829.html"},
		},
		{
			id: "IAC-032", severity: findings.SeverityCritical, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)\bcluster-admin\b`,
			description: "ClusterRoleBinding references cluster-admin role",
			cwe:         "CWE-269", keywords: []string{"cluster-admin"},
			filePatterns: []string{"*.yaml", "*.yml"},
			tags:         []string{"iac", "kubernetes", "rbac", "privilege"},
			remediation:  "Avoid binding to cluster-admin. Create custom ClusterRoles with minimum required permissions. cluster-admin grants unrestricted access to the entire cluster.",
			references:   []string{"https://cwe.mitre.org/data/definitions/269.html"},
		},
		{
			id: "IAC-033", severity: findings.SeverityMedium, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)hostPort\s*:\s*\d+`,
			description: "Container specifies hostPort binding",
			cwe:         "CWE-284", keywords: []string{"hostport"},
			filePatterns: []string{"*.yaml", "*.yml"},
			tags:         []string{"iac", "kubernetes", "network"},
			remediation:  "Use Kubernetes Services (ClusterIP, NodePort, or LoadBalancer) instead of hostPort. hostPort bypasses network policies and limits pod scheduling.",
			references:   []string{"https://cwe.mitre.org/data/definitions/284.html"},
		},
		{
			id: "IAC-034", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)type\s*:\s*LoadBalancer`,
			description: "Service type LoadBalancer exposes service externally",
			cwe:         "CWE-284", keywords: []string{"loadbalancer"},
			filePatterns: []string{"*.yaml", "*.yml"},
			tags:         []string{"iac", "kubernetes", "network"},
			remediation:  "Verify that LoadBalancer exposure is intentional. Consider using an Ingress controller with TLS termination for HTTP services instead of direct LoadBalancer exposure.",
			references:   []string{"https://cwe.mitre.org/data/definitions/284.html"},
		},
		{
			id: "IAC-035", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)runAsNonRoot\s*:\s*false`,
			description: "Kubernetes pod explicitly allows running as root",
			cwe:         "CWE-250", keywords: []string{"runasnonroot"},
			filePatterns: []string{"*.yaml", "*.yml"},
			tags:         []string{"iac", "kubernetes", "privilege"},
			remediation:  "Set runAsNonRoot: true and runAsUser to a non-zero UID. Running as root in a container increases the blast radius of container escapes.",
			references:   []string{"https://cwe.mitre.org/data/definitions/250.html"},
		},

		// =================================================================
		// GitHub Actions rules (IAC-011 to IAC-018)
		// =================================================================
		{
			id: "IAC-011", severity: findings.SeverityCritical, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)pull_request_target\s*:`,
			description: "GitHub Actions workflow uses pull_request_target trigger",
			cwe:         "CWE-94", keywords: []string{"pull_request_target"},
			filePatterns: []string{"*.yml", "*.yaml"},
			tags:         []string{"iac", "github-actions", "ci-cd"},
			remediation:  "Avoid pull_request_target unless absolutely necessary. It runs with write permissions in the context of the base branch, enabling script injection from fork PRs.",
			references:   []string{"https://cwe.mitre.org/data/definitions/94.html", "https://securitylab.github.com/research/github-actions-preventing-pwn-requests/"},
		},
		{
			id: "IAC-012", severity: findings.SeverityCritical, confidence: findings.ConfidenceHigh,
			pattern:     `\$\{\{\s*github\.event\.(issue|comment|pull_request|review|discussion)\.(title|body|head\.ref|label)`,
			description: "Workflow uses untrusted event data in expression (script injection risk)",
			cwe:         "CWE-77", keywords: []string{"github.event"},
			filePatterns: []string{"*.yml", "*.yaml"},
			tags:         []string{"iac", "github-actions", "injection"},
			remediation:  "Never use github.event properties directly in run: steps. Pass them through an environment variable and quote properly, or use an action input.",
			references:   []string{"https://cwe.mitre.org/data/definitions/77.html", "https://securitylab.github.com/research/github-actions-untrusted-input/"},
		},
		{
			id: "IAC-013", severity: findings.SeverityHigh, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)uses:\s*[a-zA-Z0-9._-]+/[a-zA-Z0-9._-]+@(v\d|main|master|latest|develop|HEAD)`,
			description: "GitHub Action pinned to mutable tag instead of commit SHA",
			cwe:         "CWE-829", keywords: []string{"uses:"},
			filePatterns: []string{"*.yml", "*.yaml"},
			tags:         []string{"iac", "github-actions", "supply-chain"},
			remediation:  "Pin third-party actions to a full commit SHA (e.g., actions/checkout@a5ac7e...). Mutable tags can be moved to point to different, potentially malicious code.",
			references:   []string{"https://cwe.mitre.org/data/definitions/829.html", "https://docs.github.com/en/actions/security-guides/security-hardening-for-github-actions"},
		},
		{
			id: "IAC-014", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)permissions\s*:\s*write-all`,
			description: "GitHub Actions workflow has write-all permissions",
			cwe:         "CWE-269", keywords: []string{"write-all"},
			filePatterns: []string{"*.yml", "*.yaml"},
			tags:         []string{"iac", "github-actions", "privilege"},
			remediation:  "Use granular permissions instead of write-all. Specify only the required scopes (e.g., contents: read, issues: write) following the principle of least privilege.",
			references:   []string{"https://cwe.mitre.org/data/definitions/269.html", "https://docs.github.com/en/actions/security-guides/automatic-token-authentication"},
		},
		{
			id: "IAC-015", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)(echo|printf)\s+.*\$\{\{\s*secrets\.`,
			description: "Secret value printed to GitHub Actions workflow logs",
			cwe:         "CWE-532", keywords: []string{"secrets."},
			filePatterns: []string{"*.yml", "*.yaml"},
			tags:         []string{"iac", "github-actions", "secrets"},
			remediation:  "Never echo secrets to logs. GitHub masks known secrets but may miss transformations. Pass secrets directly to the command that needs them via environment variables.",
			references:   []string{"https://cwe.mitre.org/data/definitions/532.html"},
		},
		{
			id: "IAC-016", severity: findings.SeverityMedium, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)runs-on\s*:\s*\[?\s*self-hosted`,
			description: "GitHub Actions workflow uses self-hosted runner",
			cwe:         "CWE-284", keywords: []string{"self-hosted"},
			filePatterns: []string{"*.yml", "*.yaml"},
			tags:         []string{"iac", "github-actions", "infrastructure"},
			remediation:  "Self-hosted runners persist state between jobs and may be shared across repositories. Use ephemeral runners, restrict with labels, and never use on public repositories.",
			references:   []string{"https://cwe.mitre.org/data/definitions/284.html", "https://docs.github.com/en/actions/hosting-your-own-runners/managing-self-hosted-runners/about-self-hosted-runners"},
		},
		{
			id: "IAC-017", severity: findings.SeverityMedium, confidence: findings.ConfidenceHigh,
			pattern:     `::set-output\s+name=`,
			description: "Workflow uses deprecated set-output command",
			cwe:         "CWE-77", keywords: []string{"set-output"},
			filePatterns: []string{"*.yml", "*.yaml"},
			tags:         []string{"iac", "github-actions", "deprecated"},
			remediation:  "Replace ::set-output with $GITHUB_OUTPUT environment file. The set-output command is deprecated and vulnerable to log injection attacks.",
			references:   []string{"https://cwe.mitre.org/data/definitions/77.html", "https://github.blog/changelog/2022-10-11-github-actions-deprecating-save-state-and-set-output-commands/"},
		},
		{
			id: "IAC-018", severity: findings.SeverityLow, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)continue-on-error\s*:\s*true`,
			description: "Workflow step suppresses failures with continue-on-error",
			cwe:         "CWE-755", keywords: []string{"continue-on-error"},
			filePatterns: []string{"*.yml", "*.yaml"},
			tags:         []string{"iac", "github-actions", "error-handling"},
			remediation:  "Avoid continue-on-error: true as it can mask security check failures. If needed, check the step outcome explicitly and fail on security-critical errors.",
			references:   []string{"https://cwe.mitre.org/data/definitions/755.html"},
		},

		// =================================================================
		// Docker Compose rules (IAC-019 to IAC-021)
		// =================================================================
		{
			id: "IAC-019", severity: findings.SeverityCritical, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)privileged\s*:\s*true`,
			description: "Docker Compose service runs in privileged mode",
			cwe:         "CWE-250", keywords: []string{"privileged"},
			filePatterns: []string{"docker-compose*.yml", "docker-compose*.yaml", "compose*.yml", "compose*.yaml"},
			tags:         []string{"iac", "docker-compose", "privilege"},
			remediation:  "Remove privileged: true. Use specific cap_add entries for required capabilities. Privileged mode gives the container full host access.",
			references:   []string{"https://cwe.mitre.org/data/definitions/250.html"},
		},
		{
			id: "IAC-020", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)network_mode\s*:\s*["']?host["']?`,
			description: "Docker Compose service uses host network mode",
			cwe:         "CWE-284", keywords: []string{"network_mode"},
			filePatterns: []string{"docker-compose*.yml", "docker-compose*.yaml", "compose*.yml", "compose*.yaml"},
			tags:         []string{"iac", "docker-compose", "network"},
			remediation:  "Use bridge networking (default) or custom networks instead of host mode. Host networking bypasses Docker's network isolation.",
			references:   []string{"https://cwe.mitre.org/data/definitions/284.html"},
		},
		{
			id: "IAC-021", severity: findings.SeverityCritical, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)/var/run/docker\.sock`,
			description: "Docker Compose service mounts Docker socket",
			cwe:         "CWE-250", keywords: []string{"docker.sock"},
			filePatterns: []string{"docker-compose*.yml", "docker-compose*.yaml", "compose*.yml", "compose*.yaml"},
			tags:         []string{"iac", "docker-compose", "privilege"},
			remediation:  "Avoid mounting the Docker socket. It gives the container full control over the Docker daemon, equivalent to root access on the host. Use Docker-in-Docker or rootless alternatives.",
			references:   []string{"https://cwe.mitre.org/data/definitions/250.html"},
		},

		// =================================================================
		// Helm / K8s packaging (IAC-046 to IAC-050)
		// =================================================================
		{
			id: "IAC-046", severity: findings.SeverityCritical, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)name\s*:\s*tiller|image\s*:.*tiller`,
			description: "Tiller (Helm v2) deployment detected",
			cwe:         "CWE-269", keywords: []string{"tiller"},
			filePatterns: []string{"*.yaml", "*.yml"},
			tags:         []string{"iac", "helm", "deprecated", "privilege"},
			remediation:  "Migrate to Helm v3 which removed Tiller. Tiller runs with cluster-admin privileges and is a well-known attack target in Kubernetes clusters.",
			references:   []string{"https://cwe.mitre.org/data/definitions/269.html", "https://helm.sh/docs/faq/changes_since_helm2/"},
		},
		{
			id: "IAC-047", severity: findings.SeverityHigh, confidence: findings.ConfidenceMedium,
			pattern:     `(?im)^(admin_?password|root_?password|master_?password)\s*:\s*["']?[a-zA-Z0-9_!@#$%^&*]{4,}["']?\s*$`,
			description: "Default or hardcoded admin password in Helm values",
			cwe:         "CWE-798", keywords: []string{"admin_password", "root_password", "master_password"},
			filePatterns: []string{"values.yaml", "values.yml", "values*.yaml", "values*.yml"},
			tags:         []string{"iac", "helm", "secrets"},
			remediation:  "Never hardcode passwords in Helm values files. Use Kubernetes Secrets, external secret managers (Vault, SOPS), or Helm --set flags for sensitive values.",
			references:   []string{"https://cwe.mitre.org/data/definitions/798.html"},
		},
		{
			id: "IAC-048", severity: findings.SeverityHigh, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)rbac\s*:\s*\n\s*(create|enabled)\s*:\s*false`,
			description: "Helm chart disables RBAC",
			cwe:         "CWE-269", keywords: []string{"rbac"},
			filePatterns: []string{"values.yaml", "values.yml", "values*.yaml", "values*.yml"},
			tags:         []string{"iac", "helm", "rbac"},
			remediation:  "Enable RBAC in Helm values. Disabling RBAC removes access control from the deployed application, allowing any authenticated user full access.",
			references:   []string{"https://cwe.mitre.org/data/definitions/269.html"},
		},
		{
			id: "IAC-049", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)pid\s*:\s*["']?host["']?`,
			description: "Docker Compose service shares host PID namespace",
			cwe:         "CWE-250", keywords: []string{"pid"},
			filePatterns: []string{"docker-compose*.yml", "docker-compose*.yaml", "compose*.yml", "compose*.yaml"},
			tags:         []string{"iac", "docker-compose", "privilege"},
			remediation:  "Remove pid: host. Sharing the host PID namespace lets the container see and interact with all host processes, breaking process isolation.",
			references:   []string{"https://cwe.mitre.org/data/definitions/250.html"},
		},
		{
			id: "IAC-050", severity: findings.SeverityMedium, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)disable_security\s*[:=]\s*true|skip_security_checks?\s*[:=]\s*true|security_enabled\s*[:=]\s*false`,
			description: "CI/CD configuration disables security checks",
			cwe:         "CWE-693", keywords: []string{"disable_security", "skip_security", "security_enabled"},
			filePatterns: []string{"*.yml", "*.yaml", "*.toml", "*.cfg"},
			tags:         []string{"iac", "ci-cd", "configuration"},
			remediation:  "Never disable security checks in CI/CD pipelines. If a check is failing, fix the underlying issue rather than disabling the check.",
			references:   []string{"https://cwe.mitre.org/data/definitions/693.html"},
		},

		// =================================================================
		// AWS CloudFormation rules (IAC-051 to IAC-080)
		// =================================================================
		{
			id: "IAC-051", severity: findings.SeverityHigh, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)AWS::S3::Bucket[^}]*(?:Properties\s*:[^}]*(?!BucketEncryption|SSEAlgorithm))[^}]*\}`,
			description: "CloudFormation S3 bucket missing encryption configuration",
			cwe:         "CWE-311", keywords: []string{"AWS::S3::Bucket", "BucketEncryption"},
			filePatterns: []string{"*.template", "*.json", "*.yaml", "*.yml"},
			tags:         []string{"iac", "cloudformation", "aws", "encryption"},
			remediation:  "Add BucketEncryption with ServerSideEncryptionConfiguration using SSEAlgorithm: aws:kms or AES256 to all S3 bucket definitions.",
			references:   []string{"https://cwe.mitre.org/data/definitions/311.html", "https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-s3-bucket-serversideencryptionrule.html"},
		},
		{
			id: "IAC-052", severity: findings.SeverityCritical, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)BlockPublicAcls\s*:\s*(false|"false")|BlockPublicPolicy\s*:\s*(false|"false")|IgnorePublicAcls\s*:\s*(false|"false")|RestrictPublicBuckets\s*:\s*(false|"false")`,
			description: "CloudFormation S3 bucket public access block disabled",
			cwe:         "CWE-284", keywords: []string{"BlockPublicAcls", "PublicAccessBlockConfiguration"},
			filePatterns: []string{"*.template", "*.json", "*.yaml", "*.yml"},
			tags:         []string{"iac", "cloudformation", "aws", "s3"},
			remediation:  "Set all PublicAccessBlockConfiguration properties to true: BlockPublicAcls, BlockPublicPolicy, IgnorePublicAcls, and RestrictPublicBuckets.",
			references:   []string{"https://cwe.mitre.org/data/definitions/284.html", "https://docs.aws.amazon.com/AmazonS3/latest/userguide/access-control-block-public-access.html"},
		},
		{
			id: "IAC-053", severity: findings.SeverityMedium, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)VersioningConfiguration\s*:\s*\n?\s*Status\s*:\s*["']?Suspended["']?`,
			description: "CloudFormation S3 bucket versioning suspended",
			cwe:         "CWE-693", keywords: []string{"VersioningConfiguration", "Suspended"},
			filePatterns: []string{"*.template", "*.json", "*.yaml", "*.yml"},
			tags:         []string{"iac", "cloudformation", "aws", "s3"},
			remediation:  "Set VersioningConfiguration Status to Enabled. Versioning protects against accidental deletion and enables data recovery.",
			references:   []string{"https://cwe.mitre.org/data/definitions/693.html"},
		},
		{
			id: "IAC-054", severity: findings.SeverityCritical, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)AWS::RDS::DBInstance[^}]*PubliclyAccessible\s*:\s*(true|"true")`,
			description: "CloudFormation RDS instance is publicly accessible",
			cwe:         "CWE-284", keywords: []string{"AWS::RDS", "PubliclyAccessible"},
			filePatterns: []string{"*.template", "*.json", "*.yaml", "*.yml"},
			tags:         []string{"iac", "cloudformation", "aws", "database"},
			remediation:  "Set PubliclyAccessible to false on RDS instances. Access databases through a VPC, bastion host, or VPN instead of public endpoints.",
			references:   []string{"https://cwe.mitre.org/data/definitions/284.html"},
		},
		{
			id: "IAC-055", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)StorageEncrypted\s*:\s*(false|"false")`,
			description: "CloudFormation RDS storage encryption disabled",
			cwe:         "CWE-311", keywords: []string{"StorageEncrypted"},
			filePatterns: []string{"*.template", "*.json", "*.yaml", "*.yml"},
			tags:         []string{"iac", "cloudformation", "aws", "database", "encryption"},
			remediation:  "Set StorageEncrypted to true on RDS instances. Enable encryption at rest to protect data from unauthorized access to the underlying storage.",
			references:   []string{"https://cwe.mitre.org/data/definitions/311.html"},
		},
		{
			id: "IAC-056", severity: findings.SeverityMedium, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)DeletionProtection\s*:\s*(false|"false")`,
			description: "CloudFormation RDS deletion protection disabled",
			cwe:         "CWE-693", keywords: []string{"DeletionProtection"},
			filePatterns: []string{"*.template", "*.json", "*.yaml", "*.yml"},
			tags:         []string{"iac", "cloudformation", "aws", "database"},
			remediation:  "Set DeletionProtection to true for production RDS instances. This prevents accidental deletion through the API or console.",
			references:   []string{"https://cwe.mitre.org/data/definitions/693.html"},
		},
		{
			id: "IAC-057", severity: findings.SeverityCritical, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)"Action"\s*:\s*\[?\s*"\*"\s*\]?`,
			description: "CloudFormation IAM policy with wildcard action",
			cwe:         "CWE-269", keywords: []string{"Action", "Effect", "Allow"},
			filePatterns: []string{"*.template", "*.json", "*.yaml", "*.yml"},
			tags:         []string{"iac", "cloudformation", "aws", "iam"},
			remediation:  "Replace wildcard actions with specific API actions required by the workload. Follow the principle of least privilege in IAM policies.",
			references:   []string{"https://cwe.mitre.org/data/definitions/269.html", "https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html"},
		},
		{
			id: "IAC-058", severity: findings.SeverityHigh, confidence: findings.ConfidenceLow,
			pattern:     `(?i)"Effect"\s*:\s*"Allow"[^}]*(?!"Condition")[^}]*"Resource"\s*:\s*"\*"`,
			description: "CloudFormation IAM policy without MFA condition on sensitive resources",
			cwe:         "CWE-308", keywords: []string{"Effect", "Allow", "Condition", "MFA"},
			filePatterns: []string{"*.template", "*.json", "*.yaml", "*.yml"},
			tags:         []string{"iac", "cloudformation", "aws", "iam"},
			remediation:  "Add a Condition block requiring MFA for sensitive operations: aws:MultiFactorAuthPresent: true. This adds an extra layer of authentication.",
			references:   []string{"https://cwe.mitre.org/data/definitions/308.html"},
		},
		{
			id: "IAC-059", severity: findings.SeverityHigh, confidence: findings.ConfidenceLow,
			pattern:     `(?i)AWS::EC2::VPC(?!.*FlowLog)(?!.*TrafficType)`,
			description: "CloudFormation VPC without flow logs",
			cwe:         "CWE-778", keywords: []string{"AWS::EC2::VPC", "FlowLog", "TrafficType"},
			filePatterns: []string{"*.template", "*.json", "*.yaml", "*.yml"},
			tags:         []string{"iac", "cloudformation", "aws", "logging"},
			remediation:  "Add an AWS::EC2::FlowLog resource for every VPC to capture network traffic metadata. Flow logs are essential for security monitoring and incident response.",
			references:   []string{"https://cwe.mitre.org/data/definitions/778.html"},
		},
		{
			id: "IAC-060", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)CidrIp\s*:\s*["']?0\.0\.0\.0/0["']?|CidrIpv6\s*:\s*["']?::/0["']?`,
			description: "CloudFormation security group allows unrestricted ingress",
			cwe:         "CWE-284", keywords: []string{"CidrIp", "0.0.0.0/0"},
			filePatterns: []string{"*.template", "*.json", "*.yaml", "*.yml"},
			tags:         []string{"iac", "cloudformation", "aws", "network"},
			remediation:  "Restrict CidrIp to specific IP ranges or use security group references. Unrestricted ingress (0.0.0.0/0) exposes resources to the entire internet.",
			references:   []string{"https://cwe.mitre.org/data/definitions/284.html"},
		},
		{
			id: "IAC-061", severity: findings.SeverityHigh, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)Protocol\s*:\s*["']?-1["']?[^}]*RuleAction\s*:\s*["']?allow["']?|RuleAction\s*:\s*["']?allow["']?[^}]*Protocol\s*:\s*["']?-1["']?`,
			description: "CloudFormation NACL allows all traffic",
			cwe:         "CWE-284", keywords: []string{"Protocol", "RuleAction", "allow"},
			filePatterns: []string{"*.template", "*.json", "*.yaml", "*.yml"},
			tags:         []string{"iac", "cloudformation", "aws", "network"},
			remediation:  "Restrict NACL rules to specific protocols and port ranges. Allowing all protocols (-1) with allow action creates overly permissive network controls.",
			references:   []string{"https://cwe.mitre.org/data/definitions/284.html"},
		},
		{
			id: "IAC-062", severity: findings.SeverityHigh, confidence: findings.ConfidenceLow,
			pattern:     `(?i)AWS::CloudTrail::Trail`,
			description: "CloudFormation CloudTrail configuration detected - verify multi-region and log validation",
			cwe:         "CWE-778", keywords: []string{"AWS::CloudTrail::Trail"},
			filePatterns: []string{"*.template", "*.json", "*.yaml", "*.yml"},
			tags:         []string{"iac", "cloudformation", "aws", "logging"},
			remediation:  "Ensure CloudTrail is configured with IsMultiRegionTrail: true, EnableLogFileValidation: true, and logs are sent to an encrypted S3 bucket with access logging.",
			references:   []string{"https://cwe.mitre.org/data/definitions/778.html"},
		},
		{
			id: "IAC-063", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)EnableKeyRotation\s*:\s*(false|"false")`,
			description: "CloudFormation KMS key rotation disabled",
			cwe:         "CWE-324", keywords: []string{"EnableKeyRotation"},
			filePatterns: []string{"*.template", "*.json", "*.yaml", "*.yml"},
			tags:         []string{"iac", "cloudformation", "aws", "encryption"},
			remediation:  "Set EnableKeyRotation to true for KMS keys. Automatic key rotation limits the amount of data encrypted under a single key version.",
			references:   []string{"https://cwe.mitre.org/data/definitions/324.html"},
		},
		{
			id: "IAC-064", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)AuthType\s*:\s*["']?NONE["']?`,
			description: "CloudFormation Lambda function URL with no authentication",
			cwe:         "CWE-306", keywords: []string{"AuthType", "NONE", "FunctionUrlConfig"},
			filePatterns: []string{"*.template", "*.json", "*.yaml", "*.yml"},
			tags:         []string{"iac", "cloudformation", "aws", "authentication"},
			remediation:  "Set AuthType to AWS_IAM for Lambda function URLs. NONE allows unauthenticated access from any caller on the internet.",
			references:   []string{"https://cwe.mitre.org/data/definitions/306.html"},
		},
		{
			id: "IAC-065", severity: findings.SeverityHigh, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)(?:Privileged\s*:\s*(true|"true")|User\s*:\s*["']?(?:0|root)["']?)`,
			description: "CloudFormation ECS task definition runs as privileged or root",
			cwe:         "CWE-250", keywords: []string{"Privileged", "ContainerDefinitions", "TaskDefinition"},
			filePatterns: []string{"*.template", "*.json", "*.yaml", "*.yml"},
			tags:         []string{"iac", "cloudformation", "aws", "privilege"},
			remediation:  "Set Privileged to false and avoid running as root (User: 0) in ECS task definitions. Use non-root users and drop unnecessary Linux capabilities.",
			references:   []string{"https://cwe.mitre.org/data/definitions/250.html"},
		},
		{
			id: "IAC-066", severity: findings.SeverityMedium, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)AWS::SNS::Topic(?:[^}](?!KmsMasterKeyId))*\}`,
			description: "CloudFormation SNS topic not encrypted with KMS",
			cwe:         "CWE-311", keywords: []string{"AWS::SNS::Topic", "KmsMasterKeyId"},
			filePatterns: []string{"*.template", "*.json", "*.yaml", "*.yml"},
			tags:         []string{"iac", "cloudformation", "aws", "encryption"},
			remediation:  "Add KmsMasterKeyId property to SNS topic resources. Encryption at rest protects messages from unauthorized access.",
			references:   []string{"https://cwe.mitre.org/data/definitions/311.html"},
		},
		{
			id: "IAC-067", severity: findings.SeverityMedium, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)SqsManagedSseEnabled\s*:\s*(false|"false")`,
			description: "CloudFormation SQS queue encryption disabled",
			cwe:         "CWE-311", keywords: []string{"SqsManagedSseEnabled", "KmsMasterKeyId", "AWS::SQS::Queue"},
			filePatterns: []string{"*.template", "*.json", "*.yaml", "*.yml"},
			tags:         []string{"iac", "cloudformation", "aws", "encryption"},
			remediation:  "Enable SQS encryption using SqsManagedSseEnabled: true or specify a KmsMasterKeyId for KMS-managed encryption.",
			references:   []string{"https://cwe.mitre.org/data/definitions/311.html"},
		},
		{
			id: "IAC-068", severity: findings.SeverityMedium, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)AccessLoggingPolicy\s*:\s*\n?\s*Enabled\s*:\s*(false|"false")|access_logs\s*:\s*\n?\s*enabled\s*:\s*(false|"false")`,
			description: "CloudFormation ELB access logging disabled",
			cwe:         "CWE-778", keywords: []string{"AccessLoggingPolicy", "access_logs"},
			filePatterns: []string{"*.template", "*.json", "*.yaml", "*.yml"},
			tags:         []string{"iac", "cloudformation", "aws", "logging"},
			remediation:  "Enable access logging on ELB resources. Access logs record all requests processed by the load balancer for security analysis and troubleshooting.",
			references:   []string{"https://cwe.mitre.org/data/definitions/778.html"},
		},
		{
			id: "IAC-069", severity: findings.SeverityCritical, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)AWS::Redshift::Cluster[^}]*PubliclyAccessible\s*:\s*(true|"true")`,
			description: "CloudFormation Redshift cluster is publicly accessible",
			cwe:         "CWE-284", keywords: []string{"AWS::Redshift", "PubliclyAccessible"},
			filePatterns: []string{"*.template", "*.json", "*.yaml", "*.yml"},
			tags:         []string{"iac", "cloudformation", "aws", "database"},
			remediation:  "Set PubliclyAccessible to false on Redshift clusters. Access data warehouses through VPC endpoints or bastion hosts.",
			references:   []string{"https://cwe.mitre.org/data/definitions/284.html"},
		},
		{
			id: "IAC-070", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)AWS::Redshift::Cluster[^}]*Encrypted\s*:\s*(false|"false")`,
			description: "CloudFormation Redshift cluster encryption disabled",
			cwe:         "CWE-311", keywords: []string{"AWS::Redshift", "Encrypted"},
			filePatterns: []string{"*.template", "*.json", "*.yaml", "*.yml"},
			tags:         []string{"iac", "cloudformation", "aws", "encryption"},
			remediation:  "Set Encrypted to true on Redshift clusters with a KMS key. Encryption at rest protects data warehouse content from unauthorized access.",
			references:   []string{"https://cwe.mitre.org/data/definitions/311.html"},
		},
		{
			id: "IAC-071", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)AtRestEncryptionEnabled\s*:\s*(false|"false")`,
			description: "CloudFormation ElastiCache encryption at rest disabled",
			cwe:         "CWE-311", keywords: []string{"AtRestEncryptionEnabled", "ElastiCache"},
			filePatterns: []string{"*.template", "*.json", "*.yaml", "*.yml"},
			tags:         []string{"iac", "cloudformation", "aws", "encryption"},
			remediation:  "Set AtRestEncryptionEnabled to true on ElastiCache replication groups. This protects cached data from unauthorized access to underlying storage.",
			references:   []string{"https://cwe.mitre.org/data/definitions/311.html"},
		},
		{
			id: "IAC-072", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)TransitEncryptionEnabled\s*:\s*(false|"false")`,
			description: "CloudFormation ElastiCache encryption in transit disabled",
			cwe:         "CWE-319", keywords: []string{"TransitEncryptionEnabled", "ElastiCache"},
			filePatterns: []string{"*.template", "*.json", "*.yaml", "*.yml"},
			tags:         []string{"iac", "cloudformation", "aws", "encryption"},
			remediation:  "Set TransitEncryptionEnabled to true on ElastiCache replication groups. This enforces TLS for data in transit between clients and the cache.",
			references:   []string{"https://cwe.mitre.org/data/definitions/319.html"},
		},
		{
			id: "IAC-073", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)ViewerProtocolPolicy\s*:\s*["']?allow-all["']?`,
			description: "CloudFormation CloudFront distribution allows HTTP (no HTTPS redirect)",
			cwe:         "CWE-319", keywords: []string{"ViewerProtocolPolicy", "allow-all"},
			filePatterns: []string{"*.template", "*.json", "*.yaml", "*.yml"},
			tags:         []string{"iac", "cloudformation", "aws", "encryption"},
			remediation:  "Set ViewerProtocolPolicy to redirect-to-https or https-only. Allowing HTTP exposes user data to eavesdropping and man-in-the-middle attacks.",
			references:   []string{"https://cwe.mitre.org/data/definitions/319.html"},
		},
		{
			id: "IAC-074", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)AWS::CloudFront::Distribution(?:[^}](?!WebACLId))*\}`,
			description: "CloudFormation CloudFront distribution without WAF",
			cwe:         "CWE-693", keywords: []string{"AWS::CloudFront::Distribution", "WebACLId"},
			filePatterns: []string{"*.template", "*.json", "*.yaml", "*.yml"},
			tags:         []string{"iac", "cloudformation", "aws", "waf"},
			remediation:  "Associate a WAF WebACL with CloudFront distributions using the WebACLId property. WAF protects against common web exploits and bot traffic.",
			references:   []string{"https://cwe.mitre.org/data/definitions/693.html"},
		},
		{
			id: "IAC-075", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)AWS::DynamoDB::Table(?:[^}](?!SSESpecification))*\}`,
			description: "CloudFormation DynamoDB table without server-side encryption specification",
			cwe:         "CWE-311", keywords: []string{"AWS::DynamoDB::Table", "SSESpecification"},
			filePatterns: []string{"*.template", "*.json", "*.yaml", "*.yml"},
			tags:         []string{"iac", "cloudformation", "aws", "encryption"},
			remediation:  "Add SSESpecification with SSEEnabled: true and optionally a KMS key. While DynamoDB encrypts by default, explicit SSESpecification ensures KMS-managed encryption.",
			references:   []string{"https://cwe.mitre.org/data/definitions/311.html"},
		},
		{
			id: "IAC-076", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)AuthorizationType\s*:\s*["']?NONE["']?`,
			description: "CloudFormation API Gateway method with no authorization",
			cwe:         "CWE-306", keywords: []string{"AuthorizationType", "NONE"},
			filePatterns: []string{"*.template", "*.json", "*.yaml", "*.yml"},
			tags:         []string{"iac", "cloudformation", "aws", "authentication"},
			remediation:  "Set AuthorizationType to AWS_IAM, COGNITO_USER_POOLS, or CUSTOM instead of NONE. Unauthenticated API endpoints are exposed to abuse.",
			references:   []string{"https://cwe.mitre.org/data/definitions/306.html"},
		},
		{
			id: "IAC-077", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)Encrypted\s*:\s*(false|"false")`,
			description: "CloudFormation EBS volume not encrypted",
			cwe:         "CWE-311", keywords: []string{"Encrypted", "AWS::EC2::Volume"},
			filePatterns: []string{"*.template", "*.json", "*.yaml", "*.yml"},
			tags:         []string{"iac", "cloudformation", "aws", "encryption"},
			remediation:  "Set Encrypted to true on EBS volumes. Enable default EBS encryption at the account level to ensure all new volumes are encrypted automatically.",
			references:   []string{"https://cwe.mitre.org/data/definitions/311.html"},
		},
		{
			id: "IAC-078", severity: findings.SeverityMedium, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)ScanOnPush\s*:\s*(false|"false")|scanOnPush\s*:\s*(false|"false")`,
			description: "CloudFormation ECR repository image scanning on push disabled",
			cwe:         "CWE-693", keywords: []string{"ScanOnPush", "ImageScanningConfiguration"},
			filePatterns: []string{"*.template", "*.json", "*.yaml", "*.yml"},
			tags:         []string{"iac", "cloudformation", "aws", "supply-chain"},
			remediation:  "Set ScanOnPush to true in ImageScanningConfiguration for ECR repositories. Automated scanning detects vulnerabilities in container images on push.",
			references:   []string{"https://cwe.mitre.org/data/definitions/693.html"},
		},
		{
			id: "IAC-079", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)AWS::SecretsManager::Secret(?:[^}](?!RotationRules|RotationSchedule))*\}`,
			description: "CloudFormation Secrets Manager secret without rotation rules",
			cwe:         "CWE-324", keywords: []string{"AWS::SecretsManager::Secret", "RotationRules"},
			filePatterns: []string{"*.template", "*.json", "*.yaml", "*.yml"},
			tags:         []string{"iac", "cloudformation", "aws", "secrets"},
			remediation:  "Add RotationRules with AutomaticallyAfterDays to Secrets Manager secrets. Automatic rotation limits the lifetime of compromised credentials.",
			references:   []string{"https://cwe.mitre.org/data/definitions/324.html"},
		},
		{
			id: "IAC-080", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)AWS::StepFunctions::StateMachine(?:[^}](?!LoggingConfiguration))*\}`,
			description: "CloudFormation Step Functions state machine without logging configuration",
			cwe:         "CWE-778", keywords: []string{"AWS::StepFunctions::StateMachine", "LoggingConfiguration"},
			filePatterns: []string{"*.template", "*.json", "*.yaml", "*.yml"},
			tags:         []string{"iac", "cloudformation", "aws", "logging"},
			remediation:  "Add LoggingConfiguration with level set to ALL or ERROR to Step Functions state machines. Logging is essential for debugging and auditing workflow executions.",
			references:   []string{"https://cwe.mitre.org/data/definitions/778.html"},
		},

		// =================================================================
		// Azure ARM/Bicep rules (IAC-081 to IAC-105)
		// =================================================================
		{
			id: "IAC-081", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)supportsHttpsTrafficOnly["']?\s*:\s*(false|"false")`,
			description: "Azure storage account allows HTTP traffic",
			cwe:         "CWE-319", keywords: []string{"supportsHttpsTrafficOnly"},
			filePatterns: []string{"*.json", "azuredeploy.json", "*.bicep"},
			tags:         []string{"iac", "arm", "azure", "encryption"},
			remediation:  "Set supportsHttpsTrafficOnly to true to enforce HTTPS on Azure storage accounts. HTTP traffic is unencrypted and vulnerable to eavesdropping.",
			references:   []string{"https://cwe.mitre.org/data/definitions/319.html", "https://learn.microsoft.com/en-us/azure/storage/common/storage-require-secure-transfer"},
		},
		{
			id: "IAC-082", severity: findings.SeverityHigh, confidence: findings.ConfidenceLow,
			pattern:     `(?i)Microsoft\.Storage/storageAccounts(?:[^}](?!encryption))*\}`,
			description: "Azure storage account missing encryption configuration",
			cwe:         "CWE-311", keywords: []string{"Microsoft.Storage/storageAccounts", "encryption"},
			filePatterns: []string{"*.json", "azuredeploy.json", "*.bicep"},
			tags:         []string{"iac", "arm", "azure", "encryption"},
			remediation:  "Configure encryption services for blob, file, table, and queue storage. Use Microsoft-managed or customer-managed keys for encryption at rest.",
			references:   []string{"https://cwe.mitre.org/data/definitions/311.html"},
		},
		{
			id: "IAC-083", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)defaultAction["']?\s*:\s*["']?Allow["']?`,
			description: "Azure storage account network rules allow access by default",
			cwe:         "CWE-284", keywords: []string{"defaultAction", "Allow", "networkAcls"},
			filePatterns: []string{"*.json", "azuredeploy.json", "*.bicep"},
			tags:         []string{"iac", "arm", "azure", "network"},
			remediation:  "Set networkAcls defaultAction to Deny and explicitly allow only required IP ranges, VNets, and resource instances.",
			references:   []string{"https://cwe.mitre.org/data/definitions/284.html"},
		},
		{
			id: "IAC-084", severity: findings.SeverityHigh, confidence: findings.ConfidenceLow,
			pattern:     `(?i)Microsoft\.Sql/servers(?:[^}](?!auditingSettings))*\}`,
			description: "Azure SQL Server without auditing settings",
			cwe:         "CWE-778", keywords: []string{"Microsoft.Sql/servers", "auditingSettings"},
			filePatterns: []string{"*.json", "azuredeploy.json", "*.bicep"},
			tags:         []string{"iac", "arm", "azure", "database", "logging"},
			remediation:  "Enable auditing on Azure SQL Server with a retention period of at least 90 days. Send audit logs to a storage account or Log Analytics workspace.",
			references:   []string{"https://cwe.mitre.org/data/definitions/778.html"},
		},
		{
			id: "IAC-085", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)transparentDataEncryption[^}]*status["']?\s*:\s*["']?Disabled["']?`,
			description: "Azure SQL Server transparent data encryption disabled",
			cwe:         "CWE-311", keywords: []string{"transparentDataEncryption", "Disabled"},
			filePatterns: []string{"*.json", "azuredeploy.json", "*.bicep"},
			tags:         []string{"iac", "arm", "azure", "database", "encryption"},
			remediation:  "Enable Transparent Data Encryption (TDE) by setting status to Enabled. TDE encrypts SQL database, transaction logs, and backups at rest.",
			references:   []string{"https://cwe.mitre.org/data/definitions/311.html"},
		},
		{
			id: "IAC-086", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)Microsoft\.Sql/servers(?:[^}](?!firewallRules))*\}`,
			description: "Azure SQL Server without firewall rules",
			cwe:         "CWE-284", keywords: []string{"Microsoft.Sql/servers", "firewallRules"},
			filePatterns: []string{"*.json", "azuredeploy.json", "*.bicep"},
			tags:         []string{"iac", "arm", "azure", "database", "network"},
			remediation:  "Configure firewall rules to restrict SQL Server access to specific IP ranges. Avoid using 0.0.0.0 as start IP which allows all Azure services.",
			references:   []string{"https://cwe.mitre.org/data/definitions/284.html"},
		},
		{
			id: "IAC-087", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)enableSoftDelete["']?\s*:\s*(false|"false")`,
			description: "Azure Key Vault soft delete disabled",
			cwe:         "CWE-693", keywords: []string{"enableSoftDelete"},
			filePatterns: []string{"*.json", "azuredeploy.json", "*.bicep"},
			tags:         []string{"iac", "arm", "azure", "secrets"},
			remediation:  "Set enableSoftDelete to true on Key Vault. Soft delete allows recovery of deleted vaults and secrets within a retention period.",
			references:   []string{"https://cwe.mitre.org/data/definitions/693.html"},
		},
		{
			id: "IAC-088", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)enablePurgeProtection["']?\s*:\s*(false|"false")`,
			description: "Azure Key Vault purge protection disabled",
			cwe:         "CWE-693", keywords: []string{"enablePurgeProtection"},
			filePatterns: []string{"*.json", "azuredeploy.json", "*.bicep"},
			tags:         []string{"iac", "arm", "azure", "secrets"},
			remediation:  "Set enablePurgeProtection to true. This prevents permanent deletion of a vault or secret during the soft delete retention period.",
			references:   []string{"https://cwe.mitre.org/data/definitions/693.html"},
		},
		{
			id: "IAC-089", severity: findings.SeverityHigh, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)permissions["']?\s*:\s*\{[^}]*["']?(keys|secrets|certificates)["']?\s*:\s*\[.*["']?all["']?`,
			description: "Azure Key Vault access policy with overly broad permissions",
			cwe:         "CWE-269", keywords: []string{"permissions", "all", "accessPolicies"},
			filePatterns: []string{"*.json", "azuredeploy.json", "*.bicep"},
			tags:         []string{"iac", "arm", "azure", "secrets", "privilege"},
			remediation:  "Follow the principle of least privilege for Key Vault access policies. Grant only specific operations (get, list) rather than 'all' permissions.",
			references:   []string{"https://cwe.mitre.org/data/definitions/269.html"},
		},
		{
			id: "IAC-090", severity: findings.SeverityCritical, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)sourceAddressPrefix["']?\s*:\s*["']?\*["']?[^}]*access["']?\s*:\s*["']?Allow["']?|access["']?\s*:\s*["']?Allow["']?[^}]*sourceAddressPrefix["']?\s*:\s*["']?\*["']?`,
			description: "Azure NSG allows all inbound traffic from any source",
			cwe:         "CWE-284", keywords: []string{"sourceAddressPrefix", "Allow"},
			filePatterns: []string{"*.json", "azuredeploy.json", "*.bicep"},
			tags:         []string{"iac", "arm", "azure", "network"},
			remediation:  "Restrict sourceAddressPrefix to specific IP ranges or service tags instead of '*'. Use Application Security Groups for fine-grained access control.",
			references:   []string{"https://cwe.mitre.org/data/definitions/284.html"},
		},
		{
			id: "IAC-091", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)httpsOnly["']?\s*:\s*(false|"false")`,
			description: "Azure App Service HTTPS-only disabled",
			cwe:         "CWE-319", keywords: []string{"httpsOnly"},
			filePatterns: []string{"*.json", "azuredeploy.json", "*.bicep"},
			tags:         []string{"iac", "arm", "azure", "encryption"},
			remediation:  "Set httpsOnly to true on App Services. This redirects all HTTP traffic to HTTPS, protecting data in transit.",
			references:   []string{"https://cwe.mitre.org/data/definitions/319.html"},
		},
		{
			id: "IAC-092", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)Microsoft\.Web/sites(?:[^}](?!identity))*\}`,
			description: "Azure App Service without managed identity",
			cwe:         "CWE-798", keywords: []string{"Microsoft.Web/sites", "identity"},
			filePatterns: []string{"*.json", "azuredeploy.json", "*.bicep"},
			tags:         []string{"iac", "arm", "azure", "authentication"},
			remediation:  "Add a managed identity (SystemAssigned or UserAssigned) to App Services. Managed identities eliminate the need for credentials in code.",
			references:   []string{"https://cwe.mitre.org/data/definitions/798.html"},
		},
		{
			id: "IAC-093", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)enableRBAC["']?\s*:\s*(false|"false")`,
			description: "Azure AKS RBAC disabled",
			cwe:         "CWE-269", keywords: []string{"enableRBAC"},
			filePatterns: []string{"*.json", "azuredeploy.json", "*.bicep"},
			tags:         []string{"iac", "arm", "azure", "kubernetes"},
			remediation:  "Set enableRBAC to true on AKS clusters. RBAC provides fine-grained access control for Kubernetes resources and is essential for multi-tenant clusters.",
			references:   []string{"https://cwe.mitre.org/data/definitions/269.html"},
		},
		{
			id: "IAC-094", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)Microsoft\.ContainerService/managedClusters(?:[^}](?!networkPolicy))*\}`,
			description: "Azure AKS cluster without network policy",
			cwe:         "CWE-284", keywords: []string{"networkPolicy", "managedClusters"},
			filePatterns: []string{"*.json", "azuredeploy.json", "*.bicep"},
			tags:         []string{"iac", "arm", "azure", "kubernetes", "network"},
			remediation:  "Configure networkPolicy (azure or calico) in the AKS network profile. Network policies control pod-to-pod traffic and enforce network segmentation.",
			references:   []string{"https://cwe.mitre.org/data/definitions/284.html"},
		},
		{
			id: "IAC-095", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)Microsoft\.ContainerService/managedClusters(?:[^}](?!aadProfile))*\}`,
			description: "Azure AKS cluster without AAD integration",
			cwe:         "CWE-306", keywords: []string{"aadProfile", "managedClusters"},
			filePatterns: []string{"*.json", "azuredeploy.json", "*.bicep"},
			tags:         []string{"iac", "arm", "azure", "kubernetes", "authentication"},
			remediation:  "Configure aadProfile on AKS clusters to integrate with Azure Active Directory. AAD provides centralized identity management and conditional access.",
			references:   []string{"https://cwe.mitre.org/data/definitions/306.html"},
		},
		{
			id: "IAC-096", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)Microsoft\.Web/sites.*kind.*functionapp(?:[^}](?!identity))*\}`,
			description: "Azure Function App without managed identity",
			cwe:         "CWE-798", keywords: []string{"functionapp", "identity"},
			filePatterns: []string{"*.json", "azuredeploy.json", "*.bicep"},
			tags:         []string{"iac", "arm", "azure", "authentication"},
			remediation:  "Add a managed identity to Function Apps. Use managed identities to securely access Key Vault, Storage, and other Azure services without storing credentials.",
			references:   []string{"https://cwe.mitre.org/data/definitions/798.html"},
		},
		{
			id: "IAC-097", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)Microsoft\.DocumentDB/databaseAccounts(?:[^}](?!virtualNetworkRules|isVirtualNetworkFilterEnabled))*\}`,
			description: "Azure Cosmos DB without network restrictions",
			cwe:         "CWE-284", keywords: []string{"DocumentDB", "virtualNetworkRules"},
			filePatterns: []string{"*.json", "azuredeploy.json", "*.bicep"},
			tags:         []string{"iac", "arm", "azure", "database", "network"},
			remediation:  "Configure virtualNetworkRules and set isVirtualNetworkFilterEnabled to true to restrict Cosmos DB access to specific virtual networks.",
			references:   []string{"https://cwe.mitre.org/data/definitions/284.html"},
		},
		{
			id: "IAC-098", severity: findings.SeverityHigh, confidence: findings.ConfidenceLow,
			pattern:     `(?i)Microsoft\.Compute/virtualMachines(?:[^}](?!diskEncryptionSet|encryptionAtHost))*\}`,
			description: "Azure VM without disk encryption",
			cwe:         "CWE-311", keywords: []string{"virtualMachines", "diskEncryptionSet"},
			filePatterns: []string{"*.json", "azuredeploy.json", "*.bicep"},
			tags:         []string{"iac", "arm", "azure", "encryption"},
			remediation:  "Enable Azure Disk Encryption or encryption at host for virtual machines. Disk encryption protects data at rest from unauthorized access to physical storage.",
			references:   []string{"https://cwe.mitre.org/data/definitions/311.html"},
		},
		{
			id: "IAC-099", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)Microsoft\.ContainerRegistry/registries(?:[^}](?!trustPolicy|contentTrust))*\}`,
			description: "Azure Container Registry without content trust",
			cwe:         "CWE-829", keywords: []string{"ContainerRegistry", "trustPolicy"},
			filePatterns: []string{"*.json", "azuredeploy.json", "*.bicep"},
			tags:         []string{"iac", "arm", "azure", "supply-chain"},
			remediation:  "Enable content trust on Azure Container Registry to ensure only signed images are pulled. This protects against tampered container images.",
			references:   []string{"https://cwe.mitre.org/data/definitions/829.html"},
		},
		{
			id: "IAC-100", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)Microsoft\.Network/applicationGateways(?:[^}](?!firewallPolicy|webApplicationFirewallConfiguration))*\}`,
			description: "Azure Application Gateway without WAF",
			cwe:         "CWE-693", keywords: []string{"applicationGateways", "firewallPolicy"},
			filePatterns: []string{"*.json", "azuredeploy.json", "*.bicep"},
			tags:         []string{"iac", "arm", "azure", "waf"},
			remediation:  "Associate a WAF policy with Application Gateway or use WAF_v2 SKU with webApplicationFirewallConfiguration. WAF protects against OWASP Top 10 threats.",
			references:   []string{"https://cwe.mitre.org/data/definitions/693.html"},
		},
		{
			id: "IAC-101", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)Microsoft\.ServiceBus/namespaces(?:[^}](?!encryption))*\}`,
			description: "Azure Service Bus namespace without encryption",
			cwe:         "CWE-311", keywords: []string{"ServiceBus", "encryption"},
			filePatterns: []string{"*.json", "azuredeploy.json", "*.bicep"},
			tags:         []string{"iac", "arm", "azure", "encryption"},
			remediation:  "Enable customer-managed key encryption on Service Bus namespaces for sensitive messaging workloads. Premium tier supports CMK encryption.",
			references:   []string{"https://cwe.mitre.org/data/definitions/311.html"},
		},
		{
			id: "IAC-102", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)Microsoft\.EventHub/namespaces(?:[^}](?!encryption))*\}`,
			description: "Azure Event Hub namespace without encryption",
			cwe:         "CWE-311", keywords: []string{"EventHub", "encryption"},
			filePatterns: []string{"*.json", "azuredeploy.json", "*.bicep"},
			tags:         []string{"iac", "arm", "azure", "encryption"},
			remediation:  "Enable customer-managed key encryption on Event Hub namespaces. Use dedicated or premium tier for CMK support on streaming data.",
			references:   []string{"https://cwe.mitre.org/data/definitions/311.html"},
		},
		{
			id: "IAC-103", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)enableNonSslPort["']?\s*:\s*(true|"true")`,
			description: "Azure Redis Cache non-SSL port enabled",
			cwe:         "CWE-319", keywords: []string{"enableNonSslPort"},
			filePatterns: []string{"*.json", "azuredeploy.json", "*.bicep"},
			tags:         []string{"iac", "arm", "azure", "encryption"},
			remediation:  "Set enableNonSslPort to false on Redis Cache instances. Non-SSL port (6379) transmits data in plaintext, exposing cached data to eavesdropping.",
			references:   []string{"https://cwe.mitre.org/data/definitions/319.html"},
		},
		{
			id: "IAC-104", severity: findings.SeverityHigh, confidence: findings.ConfidenceLow,
			pattern:     `(?i)Microsoft\.Compute/disks(?:[^}](?!encryption|diskEncryptionSet))*\}`,
			description: "Azure managed disk without encryption",
			cwe:         "CWE-311", keywords: []string{"Microsoft.Compute/disks", "encryption"},
			filePatterns: []string{"*.json", "azuredeploy.json", "*.bicep"},
			tags:         []string{"iac", "arm", "azure", "encryption"},
			remediation:  "Configure encryption with a customer-managed key or enable server-side encryption with platform-managed keys on managed disks.",
			references:   []string{"https://cwe.mitre.org/data/definitions/311.html"},
		},
		{
			id: "IAC-105", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)Microsoft\.Insights/diagnosticSettings|diagnosticSettings`,
			description: "Azure diagnostic settings detected - verify log categories and retention",
			cwe:         "CWE-778", keywords: []string{"diagnosticSettings", "Microsoft.Insights"},
			filePatterns: []string{"*.json", "azuredeploy.json", "*.bicep"},
			tags:         []string{"iac", "arm", "azure", "logging"},
			remediation:  "Ensure diagnostic settings capture all relevant log categories with adequate retention. Send logs to Log Analytics, Storage, or Event Hub for monitoring.",
			references:   []string{"https://cwe.mitre.org/data/definitions/778.html"},
		},

		// =================================================================
		// GCP rules (IAC-106 to IAC-120)
		// =================================================================
		{
			id: "IAC-106", severity: findings.SeverityCritical, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)(allUsers|allAuthenticatedUsers)`,
			description: "GCP resource grants public IAM access (allUsers/allAuthenticatedUsers)",
			cwe:         "CWE-284", keywords: []string{"allUsers", "allAuthenticatedUsers"},
			filePatterns: []string{"*.tf", "*.yaml", "*.yml", "*.json"},
			tags:         []string{"iac", "gcp", "iam"},
			remediation:  "Remove allUsers and allAuthenticatedUsers bindings. Grant access to specific service accounts or groups instead of making resources publicly accessible.",
			references:   []string{"https://cwe.mitre.org/data/definitions/284.html", "https://cloud.google.com/iam/docs/overview"},
		},
		{
			id: "IAC-107", severity: findings.SeverityMedium, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)uniform_bucket_level_access\s*[\{=][^}]*enabled\s*=\s*false|uniformBucketLevelAccess\s*:\s*\n?\s*enabled\s*:\s*false`,
			description: "GCP Cloud Storage bucket uniform access disabled",
			cwe:         "CWE-284", keywords: []string{"uniform_bucket_level_access", "uniformBucketLevelAccess"},
			filePatterns: []string{"*.tf", "*.yaml", "*.yml", "*.json"},
			tags:         []string{"iac", "gcp", "storage"},
			remediation:  "Enable uniform bucket-level access to use IAM exclusively for access control. This disables object ACLs and provides consistent, auditable permissions.",
			references:   []string{"https://cwe.mitre.org/data/definitions/284.html"},
		},
		{
			id: "IAC-108", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)google_storage_bucket(?:[^}](?!default_kms_key_name|kmsKeyName))*\}`,
			description: "GCP Cloud Storage bucket without customer-managed encryption key",
			cwe:         "CWE-311", keywords: []string{"google_storage_bucket", "default_kms_key_name"},
			filePatterns: []string{"*.tf", "*.yaml", "*.yml", "*.json"},
			tags:         []string{"iac", "gcp", "encryption"},
			remediation:  "Set default_kms_key_name on GCS buckets to use a Cloud KMS key for encryption. While Google encrypts by default, CMEK gives you control over the encryption key lifecycle.",
			references:   []string{"https://cwe.mitre.org/data/definitions/311.html"},
		},
		{
			id: "IAC-109", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)source_ranges\s*=\s*\[?\s*"0\.0\.0\.0/0"\s*\]?`,
			description: "GCP compute firewall allows traffic from all sources (0.0.0.0/0)",
			cwe:         "CWE-284", keywords: []string{"source_ranges", "0.0.0.0/0"},
			filePatterns: []string{"*.tf", "*.yaml", "*.yml", "*.json"},
			tags:         []string{"iac", "gcp", "network"},
			remediation:  "Restrict source_ranges to specific IP ranges or use service account-based firewall rules. Avoid 0.0.0.0/0 which exposes resources to the entire internet.",
			references:   []string{"https://cwe.mitre.org/data/definitions/284.html"},
		},
		{
			id: "IAC-110", severity: findings.SeverityMedium, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)enable-oslogin\s*["=:]\s*["']?(false|FALSE)["']?`,
			description: "GCP compute instance OS Login disabled",
			cwe:         "CWE-306", keywords: []string{"enable-oslogin"},
			filePatterns: []string{"*.tf", "*.yaml", "*.yml", "*.json"},
			tags:         []string{"iac", "gcp", "authentication"},
			remediation:  "Enable OS Login (enable-oslogin = true) to use IAM for SSH access management. OS Login centralizes access control and provides audit logging.",
			references:   []string{"https://cwe.mitre.org/data/definitions/306.html"},
		},
		{
			id: "IAC-111", severity: findings.SeverityMedium, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)enable_secure_boot\s*=\s*false|enableSecureBoot\s*:\s*false`,
			description: "GCP compute instance Shielded VM secure boot disabled",
			cwe:         "CWE-693", keywords: []string{"enable_secure_boot", "enableSecureBoot"},
			filePatterns: []string{"*.tf", "*.yaml", "*.yml", "*.json"},
			tags:         []string{"iac", "gcp", "integrity"},
			remediation:  "Enable Shielded VM features (secure boot, vTPM, integrity monitoring) on compute instances. Shielded VMs protect against rootkits and boot-level malware.",
			references:   []string{"https://cwe.mitre.org/data/definitions/693.html"},
		},
		{
			id: "IAC-112", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)enable_private_nodes\s*=\s*false|enablePrivateNodes\s*:\s*false`,
			description: "GCP GKE cluster private nodes disabled",
			cwe:         "CWE-284", keywords: []string{"enable_private_nodes", "enablePrivateNodes"},
			filePatterns: []string{"*.tf", "*.yaml", "*.yml", "*.json"},
			tags:         []string{"iac", "gcp", "kubernetes", "network"},
			remediation:  "Set enable_private_nodes to true in GKE private cluster config. Private nodes use internal IP addresses only, reducing exposure to the public internet.",
			references:   []string{"https://cwe.mitre.org/data/definitions/284.html"},
		},
		{
			id: "IAC-113", severity: findings.SeverityHigh, confidence: findings.ConfidenceLow,
			pattern:     `(?i)google_container_cluster(?:[^}](?!workload_identity_config|workloadIdentityConfig))*\}`,
			description: "GCP GKE cluster without workload identity",
			cwe:         "CWE-798", keywords: []string{"google_container_cluster", "workload_identity_config"},
			filePatterns: []string{"*.tf", "*.yaml", "*.yml", "*.json"},
			tags:         []string{"iac", "gcp", "kubernetes", "authentication"},
			remediation:  "Enable Workload Identity on GKE clusters to allow pods to authenticate to Google APIs using Kubernetes service accounts instead of static credentials.",
			references:   []string{"https://cwe.mitre.org/data/definitions/798.html"},
		},
		{
			id: "IAC-114", severity: findings.SeverityMedium, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)network_policy\s*[\{][^}]*enabled\s*=\s*false|networkPolicy\s*:\s*\n?\s*enabled\s*:\s*false`,
			description: "GCP GKE cluster network policy disabled",
			cwe:         "CWE-284", keywords: []string{"network_policy", "networkPolicy"},
			filePatterns: []string{"*.tf", "*.yaml", "*.yml", "*.json"},
			tags:         []string{"iac", "gcp", "kubernetes", "network"},
			remediation:  "Enable network policy on GKE clusters and deploy NetworkPolicy resources to control pod-to-pod traffic. Without it, all pods can communicate freely.",
			references:   []string{"https://cwe.mitre.org/data/definitions/284.html"},
		},
		{
			id: "IAC-115", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)ipv4_enabled\s*=\s*true|ipv4Enabled\s*:\s*true`,
			description: "GCP Cloud SQL instance has public IP enabled",
			cwe:         "CWE-284", keywords: []string{"ipv4_enabled", "ipv4Enabled"},
			filePatterns: []string{"*.tf", "*.yaml", "*.yml", "*.json"},
			tags:         []string{"iac", "gcp", "database", "network"},
			remediation:  "Set ipv4_enabled to false and use private IP connectivity for Cloud SQL instances. Public IPs expose the database to potential internet-based attacks.",
			references:   []string{"https://cwe.mitre.org/data/definitions/284.html"},
		},
		{
			id: "IAC-116", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)require_ssl\s*=\s*false|requireSsl\s*:\s*false`,
			description: "GCP Cloud SQL SSL not required",
			cwe:         "CWE-319", keywords: []string{"require_ssl", "requireSsl"},
			filePatterns: []string{"*.tf", "*.yaml", "*.yml", "*.json"},
			tags:         []string{"iac", "gcp", "database", "encryption"},
			remediation:  "Set require_ssl to true to enforce SSL connections to Cloud SQL instances. Unencrypted connections expose database traffic to eavesdropping.",
			references:   []string{"https://cwe.mitre.org/data/definitions/319.html"},
		},
		{
			id: "IAC-117", severity: findings.SeverityCritical, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)(google_bigquery_dataset_access|google_bigquery_dataset_iam)[^}]*(allAuthenticatedUsers|allUsers)`,
			description: "GCP BigQuery dataset with public access",
			cwe:         "CWE-284", keywords: []string{"bigquery", "allAuthenticatedUsers", "allUsers"},
			filePatterns: []string{"*.tf", "*.yaml", "*.yml", "*.json"},
			tags:         []string{"iac", "gcp", "database"},
			remediation:  "Remove allUsers and allAuthenticatedUsers from BigQuery dataset IAM bindings. Grant access to specific users or service accounts only.",
			references:   []string{"https://cwe.mitre.org/data/definitions/284.html"},
		},
		{
			id: "IAC-118", severity: findings.SeverityMedium, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)ingress_settings\s*=\s*["']?ALLOW_ALL["']?|ingressSettings\s*:\s*["']?ALLOW_ALL["']?`,
			description: "GCP Cloud Functions allows all ingress traffic",
			cwe:         "CWE-284", keywords: []string{"ingress_settings", "ingressSettings", "ALLOW_ALL"},
			filePatterns: []string{"*.tf", "*.yaml", "*.yml", "*.json"},
			tags:         []string{"iac", "gcp", "network"},
			remediation:  "Set ingress_settings to ALLOW_INTERNAL_ONLY or ALLOW_INTERNAL_AND_GCLB to restrict Cloud Functions to internal or load-balanced traffic only.",
			references:   []string{"https://cwe.mitre.org/data/definitions/284.html"},
		},
		{
			id: "IAC-119", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)google_kms_crypto_key(?:[^}](?!rotation_period))*\}`,
			description: "GCP Cloud KMS key without rotation period",
			cwe:         "CWE-324", keywords: []string{"google_kms_crypto_key", "rotation_period"},
			filePatterns: []string{"*.tf", "*.yaml", "*.yml", "*.json"},
			tags:         []string{"iac", "gcp", "encryption"},
			remediation:  "Set rotation_period on Cloud KMS keys (e.g., 7776000s for 90 days). Regular key rotation limits the amount of data encrypted under a single key version.",
			references:   []string{"https://cwe.mitre.org/data/definitions/324.html"},
		},
		{
			id: "IAC-120", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)google_logging_project_sink|google_logging_organization_sink|google_logging_folder_sink`,
			description: "GCP Cloud Logging sink detected - verify destination and filter",
			cwe:         "CWE-778", keywords: []string{"google_logging", "sink"},
			filePatterns: []string{"*.tf", "*.yaml", "*.yml", "*.json"},
			tags:         []string{"iac", "gcp", "logging"},
			remediation:  "Configure logging sinks to export logs to Cloud Storage, BigQuery, or Pub/Sub for long-term retention and analysis. Ensure filters capture security-relevant events.",
			references:   []string{"https://cwe.mitre.org/data/definitions/778.html"},
		},

		// =================================================================
		// Expanded Dockerfile rules (IAC-121 to IAC-130)
		// =================================================================
		{
			id: "IAC-121", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?im)^FROM\s+.+(?:\n(?!.*HEALTHCHECK))*$`,
			description: "Dockerfile missing HEALTHCHECK instruction",
			cwe:         "CWE-693", keywords: []string{"HEALTHCHECK"},
			filePatterns: []string{"Dockerfile", "Dockerfile.*", "*.dockerfile"},
			tags:         []string{"iac", "docker", "best-practice"},
			remediation:  "Add a HEALTHCHECK instruction to Dockerfiles (e.g., HEALTHCHECK --interval=30s CMD curl -f http://localhost/ || exit 1). This enables container orchestrators to detect unhealthy containers.",
			references:   []string{"https://cwe.mitre.org/data/definitions/693.html", "https://docs.docker.com/reference/dockerfile/#healthcheck"},
		},
		{
			id: "IAC-122", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?im)^FROM\s+.+(?:\n(?!.*\bUSER\b))*$`,
			description: "Dockerfile has no USER instruction (runs as root by default)",
			cwe:         "CWE-250", keywords: []string{"USER", "FROM"},
			filePatterns: []string{"Dockerfile", "Dockerfile.*", "*.dockerfile"},
			tags:         []string{"iac", "docker", "privilege"},
			remediation:  "Add a USER instruction to switch to a non-root user. Create the user with RUN adduser --disabled-password --gecos '' appuser and then USER appuser.",
			references:   []string{"https://cwe.mitre.org/data/definitions/250.html"},
		},
		{
			id: "IAC-123", severity: findings.SeverityLow, confidence: findings.ConfidenceLow,
			pattern:     `(?im)^\s*COPY\s+(?!.*--chown).*\S+\s+\S+`,
			description: "Dockerfile COPY without --chown flag",
			cwe:         "CWE-732", keywords: []string{"COPY"},
			filePatterns: []string{"Dockerfile", "Dockerfile.*", "*.dockerfile"},
			tags:         []string{"iac", "docker", "permissions"},
			remediation:  "Use COPY --chown=user:group to set proper file ownership during copy. Without --chown, copied files are owned by root regardless of the USER instruction.",
			references:   []string{"https://cwe.mitre.org/data/definitions/732.html"},
		},
		{
			id: "IAC-124", severity: findings.SeverityLow, confidence: findings.ConfidenceLow,
			pattern:     `(?im)^FROM\s+.+(?:\n(?!.*LABEL\s+maintainer))*$`,
			description: "Dockerfile missing LABEL maintainer",
			cwe:         "CWE-1059", keywords: []string{"LABEL", "maintainer"},
			filePatterns: []string{"Dockerfile", "Dockerfile.*", "*.dockerfile"},
			tags:         []string{"iac", "docker", "best-practice"},
			remediation:  "Add LABEL maintainer=\"team@example.com\" to identify the image maintainer. This aids in vulnerability response and image lifecycle management.", // nox:ignore DATA-001 -- example email in remediation text
			references:   []string{"https://cwe.mitre.org/data/definitions/1059.html"},
		},
		{
			id: "IAC-125", severity: findings.SeverityLow, confidence: findings.ConfidenceMedium,
			pattern:     `(?im)^\s*CMD\s+(?!\[)`,
			description: "Dockerfile CMD uses shell form instead of exec form",
			cwe:         "CWE-78", keywords: []string{"CMD"},
			filePatterns: []string{"Dockerfile", "Dockerfile.*", "*.dockerfile"},
			tags:         []string{"iac", "docker", "best-practice"},
			remediation:  "Use exec form for CMD: CMD [\"executable\", \"param1\", \"param2\"]. Shell form runs via /bin/sh -c which does not receive signals properly and prevents graceful shutdown.",
			references:   []string{"https://cwe.mitre.org/data/definitions/78.html"},
		},
		{
			id: "IAC-126", severity: findings.SeverityLow, confidence: findings.ConfidenceHigh,
			pattern:     `(?im)^\s*RUN\s+.*apt-get\s+install(?!.*--no-install-recommends)`,
			description: "Dockerfile apt-get install without --no-install-recommends",
			cwe:         "CWE-1104", keywords: []string{"apt-get", "install"},
			filePatterns: []string{"Dockerfile", "Dockerfile.*", "*.dockerfile"},
			tags:         []string{"iac", "docker", "best-practice"},
			remediation:  "Add --no-install-recommends to apt-get install to minimize installed packages. Fewer packages mean a smaller attack surface and smaller image size.",
			references:   []string{"https://cwe.mitre.org/data/definitions/1104.html"},
		},
		{
			id: "IAC-127", severity: findings.SeverityLow, confidence: findings.ConfidenceHigh,
			pattern:     `(?im)^\s*RUN\s+.*pip\s+install(?!.*--no-cache-dir)`,
			description: "Dockerfile pip install without --no-cache-dir",
			cwe:         "CWE-1104", keywords: []string{"pip", "install"},
			filePatterns: []string{"Dockerfile", "Dockerfile.*", "*.dockerfile"},
			tags:         []string{"iac", "docker", "best-practice"},
			remediation:  "Add --no-cache-dir to pip install to avoid caching downloaded packages in the image layer. This reduces image size without affecting functionality.",
			references:   []string{"https://cwe.mitre.org/data/definitions/1104.html"},
		},
		{
			id: "IAC-128", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?im)^\s*EXPOSE\s+22\b`,
			description: "Dockerfile exposes SSH port 22",
			cwe:         "CWE-284", keywords: []string{"EXPOSE", "22"},
			filePatterns: []string{"Dockerfile", "Dockerfile.*", "*.dockerfile"},
			tags:         []string{"iac", "docker", "network"},
			remediation:  "Remove EXPOSE 22 from Dockerfiles. SSH is not appropriate for containers. Use docker exec, kubectl exec, or container orchestrator tools for debugging.",
			references:   []string{"https://cwe.mitre.org/data/definitions/284.html"},
		},
		{
			id: "IAC-129", severity: findings.SeverityLow, confidence: findings.ConfidenceHigh,
			pattern:     `(?im)^\s*RUN\s+.*apk\s+add(?!.*--no-cache)`,
			description: "Dockerfile apk add without --no-cache",
			cwe:         "CWE-1104", keywords: []string{"apk", "add"},
			filePatterns: []string{"Dockerfile", "Dockerfile.*", "*.dockerfile"},
			tags:         []string{"iac", "docker", "best-practice"},
			remediation:  "Use apk add --no-cache to avoid storing the package index in the image layer. This reduces image size without a separate rm command.",
			references:   []string{"https://cwe.mitre.org/data/definitions/1104.html"},
		},
		{
			id: "IAC-130", severity: findings.SeverityHigh, confidence: findings.ConfidenceMedium,
			pattern:     `(?im)^\s*ENV\s+(PASSWORD|SECRET|TOKEN|API_KEY|PRIVATE_KEY|AWS_SECRET_ACCESS_KEY|DATABASE_PASSWORD|DB_PASSWORD)\s*=`,
			description: "Dockerfile ENV sets a variable with a secret-like name",
			cwe:         "CWE-798", keywords: []string{"ENV", "PASSWORD", "SECRET", "TOKEN", "API_KEY"},
			filePatterns: []string{"Dockerfile", "Dockerfile.*", "*.dockerfile"},
			tags:         []string{"iac", "docker", "secrets"},
			remediation:  "Never store secrets in ENV instructions. ENV values are visible in image history and to any process in the container. Use Docker secrets or mount secrets at runtime.",
			references:   []string{"https://cwe.mitre.org/data/definitions/798.html"},
		},

		// =================================================================
		// Expanded Kubernetes rules (IAC-131 to IAC-150)
		// =================================================================
		{
			id: "IAC-131", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)kind\s*:\s*Deployment|kind\s*:\s*StatefulSet|kind\s*:\s*DaemonSet`,
			description: "Kubernetes workload detected - verify NetworkPolicy exists",
			cwe:         "CWE-284", keywords: []string{"Deployment", "StatefulSet", "DaemonSet", "NetworkPolicy"},
			filePatterns: []string{"*.yaml", "*.yml"},
			tags:         []string{"iac", "kubernetes", "network"},
			remediation:  "Create NetworkPolicy resources for every namespace with workloads. Without NetworkPolicies, all pod-to-pod traffic is allowed by default.",
			references:   []string{"https://cwe.mitre.org/data/definitions/284.html", "https://kubernetes.io/docs/concepts/services-networking/network-policies/"},
		},
		{
			id: "IAC-132", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)kind\s*:\s*(Deployment|StatefulSet)(?:[^-](?!PodDisruptionBudget))*`,
			description: "Kubernetes workload without PodDisruptionBudget",
			cwe:         "CWE-693", keywords: []string{"PodDisruptionBudget"},
			filePatterns: []string{"*.yaml", "*.yml"},
			tags:         []string{"iac", "kubernetes", "availability"},
			remediation:  "Create a PodDisruptionBudget for each Deployment and StatefulSet to ensure minimum availability during voluntary disruptions like node drains.",
			references:   []string{"https://cwe.mitre.org/data/definitions/693.html"},
		},
		{
			id: "IAC-133", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)kind\s*:\s*Namespace(?:[^-](?!ResourceQuota))*`,
			description: "Kubernetes namespace without ResourceQuota",
			cwe:         "CWE-770", keywords: []string{"Namespace", "ResourceQuota"},
			filePatterns: []string{"*.yaml", "*.yml"},
			tags:         []string{"iac", "kubernetes", "resources"},
			remediation:  "Create ResourceQuota objects for each namespace to prevent any single namespace from consuming excessive cluster resources.",
			references:   []string{"https://cwe.mitre.org/data/definitions/770.html"},
		},
		{
			id: "IAC-134", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)kind\s*:\s*Namespace(?:[^-](?!LimitRange))*`,
			description: "Kubernetes namespace without LimitRange",
			cwe:         "CWE-770", keywords: []string{"Namespace", "LimitRange"},
			filePatterns: []string{"*.yaml", "*.yml"},
			tags:         []string{"iac", "kubernetes", "resources"},
			remediation:  "Create LimitRange objects for namespaces to set default resource requests and limits for containers that do not specify their own.",
			references:   []string{"https://cwe.mitre.org/data/definitions/770.html"},
		},
		{
			id: "IAC-135", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)securityContext\s*:(?:[^}](?!seccompProfile))*\}`,
			description: "Kubernetes pod security context missing seccomp profile",
			cwe:         "CWE-250", keywords: []string{"seccompProfile", "securityContext"},
			filePatterns: []string{"*.yaml", "*.yml"},
			tags:         []string{"iac", "kubernetes", "privilege"},
			remediation:  "Add seccompProfile with type RuntimeDefault or Localhost to the pod security context. Seccomp profiles restrict available system calls, reducing the kernel attack surface.",
			references:   []string{"https://cwe.mitre.org/data/definitions/250.html", "https://kubernetes.io/docs/tutorials/security/seccomp/"},
		},
		{
			id: "IAC-136", severity: findings.SeverityLow, confidence: findings.ConfidenceLow,
			pattern:     `(?i)container\.apparmor\.security\.beta\.kubernetes\.io`,
			description: "Kubernetes pod uses AppArmor annotation (verify profile is enforcing)",
			cwe:         "CWE-250", keywords: []string{"apparmor"},
			filePatterns: []string{"*.yaml", "*.yml"},
			tags:         []string{"iac", "kubernetes", "privilege"},
			remediation:  "Ensure AppArmor annotations reference an enforcing profile (runtime/default or a custom profile). Unconfined profiles provide no protection.",
			references:   []string{"https://cwe.mitre.org/data/definitions/250.html"},
		},
		{
			id: "IAC-137", severity: findings.SeverityMedium, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)containers\s*:\s*\n(\s+-\s+(?:(?!limits\s*:).)*$)+`,
			description: "Kubernetes container without resource limits",
			cwe:         "CWE-770", keywords: []string{"resources", "limits"},
			filePatterns: []string{"*.yaml", "*.yml"},
			tags:         []string{"iac", "kubernetes", "resources"},
			remediation:  "Set resource limits (cpu, memory) on all containers. Without limits, a single container can consume all node resources, causing denial of service.",
			references:   []string{"https://cwe.mitre.org/data/definitions/770.html", "https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/"},
		},
		{
			id: "IAC-138", severity: findings.SeverityMedium, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)containers\s*:\s*\n(\s+-\s+(?:(?!requests\s*:).)*$)+`,
			description: "Kubernetes container without resource requests",
			cwe:         "CWE-770", keywords: []string{"resources", "requests"},
			filePatterns: []string{"*.yaml", "*.yml"},
			tags:         []string{"iac", "kubernetes", "resources"},
			remediation:  "Set resource requests (cpu, memory) on all containers. Requests affect scheduling decisions and ensure the container gets guaranteed resources.",
			references:   []string{"https://cwe.mitre.org/data/definitions/770.html"},
		},
		{
			id: "IAC-139", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)containers\s*:\s*\n(\s+-\s+(?:(?!livenessProbe).)*$)+`,
			description: "Kubernetes container without liveness probe",
			cwe:         "CWE-693", keywords: []string{"livenessProbe"},
			filePatterns: []string{"*.yaml", "*.yml"},
			tags:         []string{"iac", "kubernetes", "availability"},
			remediation:  "Add a livenessProbe to containers to enable Kubernetes to detect and restart unhealthy pods. Use HTTP, TCP, or exec probes appropriate for the application.",
			references:   []string{"https://cwe.mitre.org/data/definitions/693.html"},
		},
		{
			id: "IAC-140", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)containers\s*:\s*\n(\s+-\s+(?:(?!readinessProbe).)*$)+`,
			description: "Kubernetes container without readiness probe",
			cwe:         "CWE-693", keywords: []string{"readinessProbe"},
			filePatterns: []string{"*.yaml", "*.yml"},
			tags:         []string{"iac", "kubernetes", "availability"},
			remediation:  "Add a readinessProbe to containers so Kubernetes only sends traffic to pods that are ready to serve requests. This prevents errors during startup and rolling updates.",
			references:   []string{"https://cwe.mitre.org/data/definitions/693.html"},
		},
		{
			id: "IAC-141", severity: findings.SeverityMedium, confidence: findings.ConfidenceMedium,
			pattern:     `(?im)replicas\s*:\s*1\s*$`,
			description: "Kubernetes Deployment with single replica (no high availability)",
			cwe:         "CWE-693", keywords: []string{"replicas"},
			filePatterns: []string{"*.yaml", "*.yml"},
			tags:         []string{"iac", "kubernetes", "availability"},
			remediation:  "Set replicas to at least 2 for production workloads with a PodDisruptionBudget. A single replica means any disruption causes downtime.",
			references:   []string{"https://cwe.mitre.org/data/definitions/693.html"},
		},
		{
			id: "IAC-142", severity: findings.SeverityLow, confidence: findings.ConfidenceLow,
			pattern:     `(?i)kind\s*:\s*Deployment(?:[^-](?!podAntiAffinity|anti-affinity))*`,
			description: "Kubernetes Deployment without pod anti-affinity rules",
			cwe:         "CWE-693", keywords: []string{"podAntiAffinity"},
			filePatterns: []string{"*.yaml", "*.yml"},
			tags:         []string{"iac", "kubernetes", "availability"},
			remediation:  "Add podAntiAffinity rules to spread pods across nodes and availability zones. This prevents a single node failure from taking down all replicas.",
			references:   []string{"https://cwe.mitre.org/data/definitions/693.html"},
		},
		{
			id: "IAC-143", severity: findings.SeverityMedium, confidence: findings.ConfidenceHigh,
			pattern:     `(?im)namespace\s*:\s*["']?default["']?\s*$`,
			description: "Kubernetes resource deployed to default namespace",
			cwe:         "CWE-1188", keywords: []string{"namespace", "default"},
			filePatterns: []string{"*.yaml", "*.yml"},
			tags:         []string{"iac", "kubernetes", "best-practice"},
			remediation:  "Deploy resources to dedicated namespaces instead of default. The default namespace lacks resource quotas and network policies, and makes RBAC harder to manage.",
			references:   []string{"https://cwe.mitre.org/data/definitions/1188.html"},
		},
		{
			id: "IAC-144", severity: findings.SeverityMedium, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)envFrom\s*:\s*\n\s*-\s*secretRef|env\s*:\s*\n\s*-[^}]*valueFrom\s*:\s*\n\s*secretKeyRef`,
			description: "Kubernetes secret mounted as environment variable",
			cwe:         "CWE-532", keywords: []string{"secretRef", "secretKeyRef"},
			filePatterns: []string{"*.yaml", "*.yml"},
			tags:         []string{"iac", "kubernetes", "secrets"},
			remediation:  "Mount secrets as files using volume mounts instead of environment variables. Environment variables may be logged, visible in /proc, or exposed through debug endpoints.",
			references:   []string{"https://cwe.mitre.org/data/definitions/532.html"},
		},
		{
			id: "IAC-145", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)spec\s*:\s*\n\s+containers\s*:(?:[^}](?!securityContext))*`,
			description: "Kubernetes pod without security context",
			cwe:         "CWE-250", keywords: []string{"securityContext"},
			filePatterns: []string{"*.yaml", "*.yml"},
			tags:         []string{"iac", "kubernetes", "privilege"},
			remediation:  "Add a securityContext to pod and container specs. Set runAsNonRoot: true, readOnlyRootFilesystem: true, and drop ALL capabilities as a baseline.",
			references:   []string{"https://cwe.mitre.org/data/definitions/250.html"},
		},
		{
			id: "IAC-146", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)hostPath\s*:\s*\n[^}]*(?!readOnly\s*:\s*true)`,
			description: "Kubernetes hostPath volume without readOnly flag",
			cwe:         "CWE-732", keywords: []string{"hostPath"},
			filePatterns: []string{"*.yaml", "*.yml"},
			tags:         []string{"iac", "kubernetes", "filesystem"},
			remediation:  "Set readOnly: true on hostPath volume mounts or avoid hostPath entirely. Writable hostPath mounts allow containers to modify host filesystem contents.",
			references:   []string{"https://cwe.mitre.org/data/definitions/732.html"},
		},
		{
			id: "IAC-147", severity: findings.SeverityLow, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)emptyDir\s*:\s*\{\s*\}|emptyDir\s*:\s*\n\s+(?!sizeLimit)`,
			description: "Kubernetes emptyDir volume without size limit",
			cwe:         "CWE-770", keywords: []string{"emptyDir", "sizeLimit"},
			filePatterns: []string{"*.yaml", "*.yml"},
			tags:         []string{"iac", "kubernetes", "resources"},
			remediation:  "Set sizeLimit on emptyDir volumes to prevent containers from consuming unbounded disk space on the node (e.g., emptyDir: {sizeLimit: 1Gi}).",
			references:   []string{"https://cwe.mitre.org/data/definitions/770.html"},
		},
		{
			id: "IAC-148", severity: findings.SeverityLow, confidence: findings.ConfidenceLow,
			pattern:     `(?i)kind\s*:\s*Service\s*\n(?:[^-](?!selector))*`,
			description: "Kubernetes Service without selector",
			cwe:         "CWE-284", keywords: []string{"Service", "selector"},
			filePatterns: []string{"*.yaml", "*.yml"},
			tags:         []string{"iac", "kubernetes", "network"},
			remediation:  "Verify Services without selectors are intentional (e.g., for ExternalName services or manual Endpoints). Accidental omission means no pods receive traffic.",
			references:   []string{"https://cwe.mitre.org/data/definitions/284.html"},
		},
		{
			id: "IAC-149", severity: findings.SeverityHigh, confidence: findings.ConfidenceLow,
			pattern:     `(?i)kind\s*:\s*Ingress(?:[^-](?!tls\s*:))*`,
			description: "Kubernetes Ingress without TLS configuration",
			cwe:         "CWE-319", keywords: []string{"Ingress", "tls"},
			filePatterns: []string{"*.yaml", "*.yml"},
			tags:         []string{"iac", "kubernetes", "encryption"},
			remediation:  "Add a tls section to Ingress resources with a valid TLS secret. Unencrypted ingress exposes user traffic to eavesdropping and modification.",
			references:   []string{"https://cwe.mitre.org/data/definitions/319.html"},
		},
		{
			id: "IAC-150", severity: findings.SeverityMedium, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)kind\s*:\s*ConfigMap[^}]*(password|secret|token|api[_-]?key|private[_-]?key|credentials)\s*[:=]`,
			description: "Kubernetes ConfigMap may contain sensitive data",
			cwe:         "CWE-312", keywords: []string{"ConfigMap", "password", "secret", "token"},
			filePatterns: []string{"*.yaml", "*.yml"},
			tags:         []string{"iac", "kubernetes", "secrets"},
			remediation:  "Use Kubernetes Secrets (or external secret managers like Vault) instead of ConfigMaps for sensitive data. ConfigMap data is stored unencrypted in etcd by default.",
			references:   []string{"https://cwe.mitre.org/data/definitions/312.html"},
		},

		// =================================================================
		// Expanded GitHub Actions rules (IAC-151 to IAC-160)
		// =================================================================
		{
			id: "IAC-151", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)(aws-access-key-id|azure-credentials|google-credentials)\s*:\s*\$\{\{\s*secrets\.`,
			description: "GitHub Actions uses static credentials instead of OIDC for cloud authentication",
			cwe:         "CWE-798", keywords: []string{"aws-access-key-id", "azure-credentials", "OIDC"},
			filePatterns: []string{"*.yml", "*.yaml"},
			tags:         []string{"iac", "github-actions", "authentication"},
			remediation:  "Use OIDC (OpenID Connect) for cloud provider authentication instead of static credentials. Configure GitHub as an identity provider in AWS, Azure, or GCP.",
			references:   []string{"https://cwe.mitre.org/data/definitions/798.html", "https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect"},
		},
		{
			id: "IAC-152", severity: findings.SeverityLow, confidence: findings.ConfidenceLow,
			pattern:     `(?im)^\s+steps\s*:\s*\n(\s+-\s+(uses|run)\s*:.*\n){15,}`,
			description: "GitHub Actions workflow has many steps - consider reusable workflows",
			cwe:         "CWE-1059", keywords: []string{"steps", "uses"},
			filePatterns: []string{"*.yml", "*.yaml"},
			tags:         []string{"iac", "github-actions", "best-practice"},
			remediation:  "Extract common step sequences into reusable workflows (workflow_call trigger) or composite actions. This improves maintainability and reduces duplication.",
			references:   []string{"https://cwe.mitre.org/data/definitions/1059.html"},
		},
		{
			id: "IAC-153", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)actions/upload-artifact(?!.*attestation)`,
			description: "GitHub Actions artifact upload without attestation",
			cwe:         "CWE-829", keywords: []string{"upload-artifact", "attestation"},
			filePatterns: []string{"*.yml", "*.yaml"},
			tags:         []string{"iac", "github-actions", "supply-chain"},
			remediation:  "Use artifact attestation (actions/attest-build-provenance) alongside upload-artifact to create SLSA-compliant provenance for build artifacts.",
			references:   []string{"https://cwe.mitre.org/data/definitions/829.html"},
		},
		{
			id: "IAC-154", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)\.github/dependabot\.yml|\.github/dependabot\.yaml`,
			description: "Dependabot configuration detected - verify update schedule and security updates",
			cwe:         "CWE-1104", keywords: []string{"dependabot"},
			filePatterns: []string{"dependabot.yml", "dependabot.yaml"},
			tags:         []string{"iac", "github-actions", "supply-chain"},
			remediation:  "Ensure Dependabot is configured for all package ecosystems with security-updates enabled and appropriate update schedule (at least weekly).",
			references:   []string{"https://cwe.mitre.org/data/definitions/1104.html"},
		},
		{
			id: "IAC-155", severity: findings.SeverityMedium, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)workflow_dispatch\s*:\s*$|workflow_dispatch\s*:\s*\n\s+(?!.*environment)`,
			description: "GitHub Actions manual trigger without environment approval",
			cwe:         "CWE-284", keywords: []string{"workflow_dispatch"},
			filePatterns: []string{"*.yml", "*.yaml"},
			tags:         []string{"iac", "github-actions", "ci-cd"},
			remediation:  "Require environment approval for workflow_dispatch triggers that perform sensitive operations. Use GitHub environments with required reviewers for deployment gates.",
			references:   []string{"https://cwe.mitre.org/data/definitions/284.html"},
		},
		{
			id: "IAC-156", severity: findings.SeverityMedium, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)actions/cache@[^}]*key\s*:\s*.*\$\{\{\s*github\.ref\s*\}\}`,
			description: "GitHub Actions cache key uses branch ref (potential cache poisoning)",
			cwe:         "CWE-345", keywords: []string{"actions/cache", "github.ref"},
			filePatterns: []string{"*.yml", "*.yaml"},
			tags:         []string{"iac", "github-actions", "supply-chain"},
			remediation:  "Use hashFiles() for cache keys instead of branch refs. Branch-based cache keys may allow cache poisoning from feature branches or fork PRs.",
			references:   []string{"https://cwe.mitre.org/data/definitions/345.html"},
		},
		{
			id: "IAC-157", severity: findings.SeverityMedium, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)uses:\s*[a-zA-Z0-9._-]+/[a-zA-Z0-9._-]+@v[12]\b`,
			description: "GitHub Action uses deprecated major version (v1 or v2)",
			cwe:         "CWE-1104", keywords: []string{"uses:", "@v1", "@v2"},
			filePatterns: []string{"*.yml", "*.yaml"},
			tags:         []string{"iac", "github-actions", "deprecated"},
			remediation:  "Update to the latest major version of third-party actions. Older versions may have known vulnerabilities and miss important security improvements.",
			references:   []string{"https://cwe.mitre.org/data/definitions/1104.html"},
		},
		{
			id: "IAC-158", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)github/codeql-action/analyze|github/codeql-action/init`,
			description: "GitHub CodeQL analysis detected - verify language coverage",
			cwe:         "CWE-693", keywords: []string{"codeql-action"},
			filePatterns: []string{"*.yml", "*.yaml"},
			tags:         []string{"iac", "github-actions", "security"},
			remediation:  "Ensure CodeQL is configured for all supported languages in the repository. Add codeql-analysis.yml workflow if not present for automated security scanning.",
			references:   []string{"https://cwe.mitre.org/data/definitions/693.html"},
		},
		{
			id: "IAC-159", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)branches\s*:\s*\n\s*-\s*(main|master)\s*$(?:[^}](?!required_status_checks|required_pull_request_reviews))*`,
			description: "GitHub workflow triggers on main branch without branch protection indicators",
			cwe:         "CWE-284", keywords: []string{"branches", "main", "master"},
			filePatterns: []string{"*.yml", "*.yaml"},
			tags:         []string{"iac", "github-actions", "ci-cd"},
			remediation:  "Enable branch protection rules for main/master: require pull request reviews, status checks, signed commits, and linear history.",
			references:   []string{"https://cwe.mitre.org/data/definitions/284.html"},
		},
		{
			id: "IAC-160", severity: findings.SeverityHigh, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)(>>?\s*\$GITHUB_OUTPUT|>>?\s*\$GITHUB_ENV).*\$\{\{\s*secrets\.`,
			description: "GitHub Actions workflow outputs secrets to GITHUB_OUTPUT or GITHUB_ENV",
			cwe:         "CWE-532", keywords: []string{"GITHUB_OUTPUT", "GITHUB_ENV", "secrets"},
			filePatterns: []string{"*.yml", "*.yaml"},
			tags:         []string{"iac", "github-actions", "secrets"},
			remediation:  "Never write secrets to GITHUB_OUTPUT or GITHUB_ENV. These can be read by subsequent steps and may be exposed in workflow logs or artifacts.",
			references:   []string{"https://cwe.mitre.org/data/definitions/532.html"},
		},

		// =================================================================
		// Expanded Terraform rules (IAC-161 to IAC-175)
		// =================================================================
		{
			id: "IAC-161", severity: findings.SeverityMedium, confidence: findings.ConfidenceMedium,
			pattern:     `(?im)^\s*provider\s+"[^"]+"\s*\{\s*$`,
			description: "Terraform provider without version constraints",
			cwe:         "CWE-829", keywords: []string{"provider", "required_providers"},
			filePatterns: []string{"*.tf"},
			tags:         []string{"iac", "terraform", "supply-chain"},
			remediation:  "Add version constraints in required_providers block (e.g., version = \"~> 5.0\"). Unpinned providers may introduce breaking changes or vulnerabilities on upgrade.",
			references:   []string{"https://cwe.mitre.org/data/definitions/829.html"},
		},
		{
			id: "IAC-162", severity: findings.SeverityHigh, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)backend\s+"s3"\s*\{(?:[^}](?!encrypt\s*=\s*true))*\}`,
			description: "Terraform S3 backend without encryption",
			cwe:         "CWE-311", keywords: []string{"backend", "encrypt"},
			filePatterns: []string{"*.tf"},
			tags:         []string{"iac", "terraform", "encryption"},
			remediation:  "Set encrypt = true in the S3 backend configuration. State files contain sensitive information and must be encrypted at rest.",
			references:   []string{"https://cwe.mitre.org/data/definitions/311.html"},
		},
		{
			id: "IAC-163", severity: findings.SeverityHigh, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)backend\s+"s3"\s*\{(?:[^}](?!dynamodb_table))*\}`,
			description: "Terraform S3 backend without state locking (no DynamoDB table)",
			cwe:         "CWE-362", keywords: []string{"backend", "dynamodb_table"},
			filePatterns: []string{"*.tf"},
			tags:         []string{"iac", "terraform", "state"},
			remediation:  "Add dynamodb_table to the S3 backend configuration for state file locking. Without locking, concurrent terraform apply runs can corrupt state.",
			references:   []string{"https://cwe.mitre.org/data/definitions/362.html"},
		},
		{
			id: "IAC-164", severity: findings.SeverityLow, confidence: findings.ConfidenceMedium,
			pattern:     `(?im)^variable\s+"[^"]+"\s*\{\s*\n(?:[^}](?!validation\s*\{))*\}`,
			description: "Terraform variable without validation block",
			cwe:         "CWE-20", keywords: []string{"variable", "validation"},
			filePatterns: []string{"*.tf"},
			tags:         []string{"iac", "terraform", "best-practice"},
			remediation:  "Add validation blocks to variables to enforce value constraints at plan time. Validation prevents invalid configurations from being applied.",
			references:   []string{"https://cwe.mitre.org/data/definitions/20.html"},
		},
		{
			id: "IAC-165", severity: findings.SeverityHigh, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)provisioner\s+"local-exec"\s*\{`,
			description: "Terraform uses local-exec provisioner",
			cwe:         "CWE-78", keywords: []string{"local-exec", "provisioner"},
			filePatterns: []string{"*.tf"},
			tags:         []string{"iac", "terraform", "execution"},
			remediation:  "Avoid local-exec provisioners as they execute arbitrary commands on the machine running Terraform. Use provider-native resources or null_resource with explicit commands.",
			references:   []string{"https://cwe.mitre.org/data/definitions/78.html"},
		},
		{
			id: "IAC-166", severity: findings.SeverityCritical, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)provisioner\s+"remote-exec"\s*\{`,
			description: "Terraform uses remote-exec provisioner",
			cwe:         "CWE-78", keywords: []string{"remote-exec", "provisioner"},
			filePatterns: []string{"*.tf"},
			tags:         []string{"iac", "terraform", "execution"},
			remediation:  "Avoid remote-exec provisioners as they require SSH/WinRM access and execute commands on remote machines. Use configuration management tools (Ansible, Chef) or cloud-init instead.",
			references:   []string{"https://cwe.mitre.org/data/definitions/78.html"},
		},
		{
			id: "IAC-167", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)(aws_db_instance|aws_rds_cluster|aws_s3_bucket|google_sql_database_instance)(?:[^}](?!prevent_destroy\s*=\s*true))*\}`,
			description: "Terraform data resource without lifecycle prevent_destroy",
			cwe:         "CWE-693", keywords: []string{"prevent_destroy", "lifecycle"},
			filePatterns: []string{"*.tf"},
			tags:         []string{"iac", "terraform", "best-practice"},
			remediation:  "Add lifecycle { prevent_destroy = true } to critical data resources (databases, storage). This prevents accidental deletion through terraform destroy.",
			references:   []string{"https://cwe.mitre.org/data/definitions/693.html"},
		},
		{
			id: "IAC-168", severity: findings.SeverityHigh, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)source\s*=\s*"git::|source\s*=\s*"github\.com|source\s*=\s*"https://(?!.*\?ref=)`,
			description: "Terraform module source not pinned to specific version or ref",
			cwe:         "CWE-829", keywords: []string{"source", "module"},
			filePatterns: []string{"*.tf"},
			tags:         []string{"iac", "terraform", "supply-chain"},
			remediation:  "Pin module sources to specific versions using ?ref=v1.0.0 for git sources or version constraints for registry modules. Unpinned modules may change unexpectedly.",
			references:   []string{"https://cwe.mitre.org/data/definitions/829.html"},
		},
		{
			id: "IAC-169", severity: findings.SeverityMedium, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)terraform\s*\{(?:[^}](?!required_version))*\}`,
			description: "Terraform configuration missing required_version",
			cwe:         "CWE-829", keywords: []string{"required_version", "terraform"},
			filePatterns: []string{"*.tf"},
			tags:         []string{"iac", "terraform", "best-practice"},
			remediation:  "Add required_version to the terraform block (e.g., required_version = \">= 1.5.0\"). This prevents running with incompatible Terraform versions.",
			references:   []string{"https://cwe.mitre.org/data/definitions/829.html"},
		},
		{
			id: "IAC-170", severity: findings.SeverityMedium, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)backend\s+"s3"\s*\{(?:[^}](?!versioning))*\}`,
			description: "Terraform S3 backend without state file versioning",
			cwe:         "CWE-693", keywords: []string{"backend", "versioning"},
			filePatterns: []string{"*.tf"},
			tags:         []string{"iac", "terraform", "state"},
			remediation:  "Enable versioning on the S3 bucket used for state storage. Versioning allows recovery from accidental state corruption or deletion.",
			references:   []string{"https://cwe.mitre.org/data/definitions/693.html"},
		},
		{
			id: "IAC-171", severity: findings.SeverityMedium, confidence: findings.ConfidenceMedium,
			pattern:     `(?im)^output\s+"[^"]*(?:password|secret|token|key|credential)[^"]*"\s*\{(?:[^}](?!sensitive\s*=\s*true))*\}`,
			description: "Terraform output with sensitive name not marked as sensitive",
			cwe:         "CWE-532", keywords: []string{"output", "sensitive"},
			filePatterns: []string{"*.tf"},
			tags:         []string{"iac", "terraform", "secrets"},
			remediation:  "Add sensitive = true to output blocks that contain secrets. Without this flag, sensitive values are displayed in terraform output and plan.",
			references:   []string{"https://cwe.mitre.org/data/definitions/532.html"},
		},
		{
			id: "IAC-172", severity: findings.SeverityMedium, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)data\s+"[^"]*"\s+"[^"]*(?:password|secret|token|key|credential)[^"]*"`,
			description: "Terraform data source used to retrieve secrets",
			cwe:         "CWE-312", keywords: []string{"data", "password", "secret"},
			filePatterns: []string{"*.tf"},
			tags:         []string{"iac", "terraform", "secrets"},
			remediation:  "Use a dedicated secrets manager (AWS Secrets Manager, HashiCorp Vault) with the corresponding Terraform provider instead of data sources for secret retrieval.",
			references:   []string{"https://cwe.mitre.org/data/definitions/312.html"},
		},
		{
			id: "IAC-173", severity: findings.SeverityLow, confidence: findings.ConfidenceLow,
			pattern:     `(?i)resource\s+"aws_[^"]+"\s+"[^"]+"\s*\{(?:[^}](?!tags\s*[={]))*\}`,
			description: "Terraform AWS resource without tags",
			cwe:         "CWE-1059", keywords: []string{"tags"},
			filePatterns: []string{"*.tf"},
			tags:         []string{"iac", "terraform", "best-practice"},
			remediation:  "Add tags to all AWS resources for cost allocation, access control, and resource management. Use default_tags in the provider block for consistent tagging.",
			references:   []string{"https://cwe.mitre.org/data/definitions/1059.html"},
		},
		{
			id: "IAC-174", severity: findings.SeverityMedium, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)resource\s+"aws_launch_configuration"|resource\s+"aws_autoscaling_attachment"|resource\s+"aws_iam_access_key"`,
			description: "Terraform uses deprecated or legacy resource type",
			cwe:         "CWE-1104", keywords: []string{"aws_launch_configuration", "deprecated"},
			filePatterns: []string{"*.tf"},
			tags:         []string{"iac", "terraform", "deprecated"},
			remediation:  "Replace deprecated resources with their successors: aws_launch_configuration -> aws_launch_template, aws_iam_access_key -> IAM roles with OIDC.",
			references:   []string{"https://cwe.mitre.org/data/definitions/1104.html"},
		},
		{
			id: "IAC-175", severity: findings.SeverityCritical, confidence: findings.ConfidenceHigh,
			pattern:     `(?i)terraform\s+apply\s+(-auto-approve|--auto-approve)`,
			description: "Terraform apply with auto-approve bypasses plan review",
			cwe:         "CWE-284", keywords: []string{"auto-approve", "terraform apply"},
			filePatterns: []string{"*.sh", "*.yml", "*.yaml", "*.bash", "Makefile"},
			tags:         []string{"iac", "terraform", "ci-cd"},
			remediation:  "Never use -auto-approve in production pipelines. Use terraform plan with saved plan files and require manual approval before terraform apply plan.out.",
			references:   []string{"https://cwe.mitre.org/data/definitions/284.html"},
		},

		// =================================================================
		// Helm / Docker Compose expansions (IAC-176 to IAC-185)
		// =================================================================
		{
			id: "IAC-176", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)kind\s*:\s*Deployment(?:[^}](?!securityContext))*\}`,
			description: "Helm chart template missing securityContext",
			cwe:         "CWE-250", keywords: []string{"securityContext", "template"},
			filePatterns: []string{"*.yaml", "*.yml", "*.tpl"},
			tags:         []string{"iac", "helm", "privilege"},
			remediation:  "Include securityContext in Helm chart deployment templates. Set runAsNonRoot: true, readOnlyRootFilesystem: true, and drop ALL capabilities as defaults.",
			references:   []string{"https://cwe.mitre.org/data/definitions/250.html"},
		},
		{
			id: "IAC-177", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)resources\s*:\s*\{\s*\}|resources\s*:\s*\n\s+#|resources\s*:\s*null`,
			description: "Helm values file with empty or null resource limits",
			cwe:         "CWE-770", keywords: []string{"resources"},
			filePatterns: []string{"values.yaml", "values.yml", "values*.yaml", "values*.yml"},
			tags:         []string{"iac", "helm", "resources"},
			remediation:  "Define resource requests and limits in Helm values (cpu, memory). Empty resources mean containers run without constraints and can starve other workloads.",
			references:   []string{"https://cwe.mitre.org/data/definitions/770.html"},
		},
		{
			id: "IAC-178", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)serviceAccount\s*:\s*\n\s+create\s*:\s*false`,
			description: "Helm chart disables service account creation",
			cwe:         "CWE-269", keywords: []string{"serviceAccount", "create"},
			filePatterns: []string{"values.yaml", "values.yml", "values*.yaml", "values*.yml"},
			tags:         []string{"iac", "helm", "authentication"},
			remediation:  "Enable service account creation (serviceAccount.create: true) for each Helm release. Dedicated service accounts enable proper RBAC and pod identity.",
			references:   []string{"https://cwe.mitre.org/data/definitions/269.html"},
		},
		{
			id: "IAC-179", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)(services|version)\s*:(?:[^}](?!deploy\s*:\s*\n\s+resources|mem_limit|cpus))*`,
			description: "Docker Compose service without resource limits",
			cwe:         "CWE-770", keywords: []string{"deploy", "resources", "mem_limit"},
			filePatterns: []string{"docker-compose*.yml", "docker-compose*.yaml", "compose*.yml", "compose*.yaml"},
			tags:         []string{"iac", "docker-compose", "resources"},
			remediation:  "Add deploy.resources.limits (memory, cpus) or mem_limit/cpus to Compose services. Without limits, a single container can exhaust host resources.",
			references:   []string{"https://cwe.mitre.org/data/definitions/770.html"},
		},
		{
			id: "IAC-180", severity: findings.SeverityMedium, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)volumes\s*:\s*\n(\s+-\s+(?!.*:ro\b|.*:readonly\b|.*read_only).*:\s*/[^\n]*\n)+`,
			description: "Docker Compose volume mount without read-only flag",
			cwe:         "CWE-732", keywords: []string{"volumes", "ro", "readonly"},
			filePatterns: []string{"docker-compose*.yml", "docker-compose*.yaml", "compose*.yml", "compose*.yaml"},
			tags:         []string{"iac", "docker-compose", "filesystem"},
			remediation:  "Add :ro suffix to volume mounts that do not need write access (e.g., ./config:/app/config:ro). Read-only mounts limit the damage from container compromise.",
			references:   []string{"https://cwe.mitre.org/data/definitions/732.html"},
		},
		{
			id: "IAC-181", severity: findings.SeverityHigh, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)tmpfs\s*:\s*\n?\s*-?\s*/run/secrets|tmpfs\s*:\s*["']?/run/secrets["']?`,
			description: "Docker Compose uses tmpfs for secrets directory",
			cwe:         "CWE-312", keywords: []string{"tmpfs", "secrets"},
			filePatterns: []string{"docker-compose*.yml", "docker-compose*.yaml", "compose*.yml", "compose*.yaml"},
			tags:         []string{"iac", "docker-compose", "secrets"},
			remediation:  "Use Docker secrets (secrets: top-level key) instead of tmpfs for sensitive data. Docker secrets are encrypted at rest in Swarm mode and mounted read-only.",
			references:   []string{"https://cwe.mitre.org/data/definitions/312.html"},
		},
		{
			id: "IAC-182", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)(services\s*:\s*\n\s+\w+\s*:\s*\n(?:[^}](?!healthcheck))*){1}`,
			description: "Docker Compose service without health check",
			cwe:         "CWE-693", keywords: []string{"healthcheck"},
			filePatterns: []string{"docker-compose*.yml", "docker-compose*.yaml", "compose*.yml", "compose*.yaml"},
			tags:         []string{"iac", "docker-compose", "availability"},
			remediation:  "Add healthcheck to Compose services to enable automatic restart of unhealthy containers and proper dependency ordering with depends_on condition: service_healthy.",
			references:   []string{"https://cwe.mitre.org/data/definitions/693.html"},
		},
		{
			id: "IAC-183", severity: findings.SeverityMedium, confidence: findings.ConfidenceLow,
			pattern:     `(?i)kind\s*:\s*(Deployment|StatefulSet)(?:[^}](?!PodDisruptionBudget|podDisruptionBudget))*`,
			description: "Helm chart without PodDisruptionBudget template",
			cwe:         "CWE-693", keywords: []string{"PodDisruptionBudget"},
			filePatterns: []string{"*.yaml", "*.yml", "*.tpl"},
			tags:         []string{"iac", "helm", "availability"},
			remediation:  "Include a PodDisruptionBudget template in Helm charts to ensure minimum availability during voluntary disruptions like node upgrades and cluster autoscaling.",
			references:   []string{"https://cwe.mitre.org/data/definitions/693.html"},
		},
		{
			id: "IAC-184", severity: findings.SeverityMedium, confidence: findings.ConfidenceMedium,
			pattern:     `(?i)user\s*:\s*["']?(root|0)["']?\s*$`,
			description: "Docker Compose service runs as root user",
			cwe:         "CWE-250", keywords: []string{"user", "root"},
			filePatterns: []string{"docker-compose*.yml", "docker-compose*.yaml", "compose*.yml", "compose*.yaml"},
			tags:         []string{"iac", "docker-compose", "privilege"},
			remediation:  "Set user to a non-root UID (e.g., user: \"1000:1000\") in Compose services. Running as root increases the blast radius of container escapes.",
			references:   []string{"https://cwe.mitre.org/data/definitions/250.html"},
		},
		{
			id: "IAC-185", severity: findings.SeverityMedium, confidence: findings.ConfidenceMedium,
			pattern:     `(?im)^image\s*:\s*\n?\s+pullPolicy\s*:\s*["']?Always["']?|imagePullPolicy\s*:\s*["']?Always["']?`,
			description: "Helm values or template uses Always image pull policy without pinned tag",
			cwe:         "CWE-829", keywords: []string{"pullPolicy", "imagePullPolicy", "Always"},
			filePatterns: []string{"values.yaml", "values.yml", "values*.yaml", "values*.yml", "*.yaml", "*.yml"},
			tags:         []string{"iac", "helm", "supply-chain"},
			remediation:  "Use imagePullPolicy: IfNotPresent with pinned image tags and digests. Always pull policy with mutable tags can silently deploy different image versions.",
			references:   []string{"https://cwe.mitre.org/data/definitions/829.html"},
		},
	}

	out := make([]rules.Rule, len(defs))
	for i := range defs {
		out[i] = rules.Rule{
			ID:           defs[i].id,
			Version:      "1.0",
			Description:  defs[i].description,
			Severity:     defs[i].severity,
			Confidence:   defs[i].confidence,
			MatcherType:  "regex",
			Pattern:      defs[i].pattern,
			FilePatterns: defs[i].filePatterns,
			Keywords:     defs[i].keywords,
			Tags:         defs[i].tags,
			Metadata:     map[string]string{"cwe": defs[i].cwe},
			Remediation:  defs[i].remediation,
			References:   defs[i].references,
		}
	}
	return out
}

#!/bin/sh
# Pre-commit hook for the nox repository.
# Runs the same checks as CI to catch issues before pushing.
# Install: make hooks   or   cp scripts/pre-commit .git/hooks/pre-commit

failed=0

# 1. Check gofmt on staged Go files.
gofiles=$(git diff --cached --name-only --diff-filter=ACM -- '*.go')
if [ -n "$gofiles" ]; then
    # shellcheck disable=SC2086
    unformatted=$(gofmt -l $gofiles)
    if [ -n "$unformatted" ]; then
        echo "pre-commit: gofmt check failed:"
        echo "$unformatted"
        echo "  run: gofmt -w <file>"
        failed=1
    fi
fi

# 2. Run go vet.
if ! go vet ./... >/dev/null 2>&1; then
    echo "pre-commit: go vet found issues"
    go vet ./... 2>&1 || true
    failed=1
fi

# 3. Run golangci-lint (only new issues vs HEAD) — includes gocritic.
if command -v golangci-lint >/dev/null 2>&1; then
    if ! golangci-lint run --new-from-rev=HEAD ./... 2>&1; then
        echo "pre-commit: golangci-lint found issues (includes gocritic)"
        failed=1
    fi
else
    echo "pre-commit: golangci-lint not found, skipping lint check"
    echo "  install: https://golangci-lint.run/welcome/install/"
fi

# 4. Run coverctl coverage check (CI-style profile).
if command -v coverctl >/dev/null 2>&1; then
    if ! go test -coverprofile=coverage.out ./... >/dev/null 2>&1; then
        echo "pre-commit: go test coverage run failed"
        go test -coverprofile=coverage.out ./... 2>&1 || true
        failed=1
    elif ! coverctl -q check --config .coverctl.yaml --profile coverage.out 2>&1; then
        echo "pre-commit: coverctl coverage thresholds not met"
        failed=1
    fi
else
    echo "pre-commit: coverctl not found, skipping coverage check"
    echo "  install: go install github.com/nicholasgasior/coverctl@latest"
fi

# 5. Run nox security scan on staged files.
nox_bin=""
if command -v nox >/dev/null 2>&1; then
    nox_bin="nox"
elif [ -x ./nox ]; then
    nox_bin="./nox"
fi

if [ -n "$nox_bin" ]; then
    $nox_bin scan --staged --severity-threshold high --quiet . || nox_exit=$?
    nox_exit=${nox_exit:-0}
    if [ "$nox_exit" -eq 1 ]; then
        echo ""
        echo "pre-commit: nox found security issues in staged files"
        echo "  use '// nox:ignore RULE-ID -- reason' to suppress false positives"
        failed=1
    fi
fi

if [ $failed -ne 0 ]; then
    echo ""
    echo "pre-commit: checks failed — fix issues above or use 'git commit --no-verify' to skip"
    exit 1
fi

name: Plugin Release

on:
  workflow_call:
    inputs:
      go-version:
        description: 'Go version to use'
        required: false
        type: string
        default: '1.25'
      registry-repo:
        description: 'Registry repository for index update dispatch'
        required: false
        type: string
        default: 'nox-hq/nox-registry'
    secrets:
      NOX_SIGNING_KEY:
        description: 'Ed25519 private key for artifact signing (base64-encoded)'
        required: true
      REGISTRY_DISPATCH_TOKEN:
        description: 'GitHub token with repo dispatch permission on registry repo'
        required: false

jobs:
  release:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - os: linux
            arch: amd64
            goos: linux
            goarch: amd64
          - os: linux
            arch: arm64
            goos: linux
            goarch: arm64
          - os: darwin
            arch: amd64
            goos: darwin
            goarch: amd64
          - os: darwin
            arch: arm64
            goos: darwin
            goarch: arm64

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go-version }}

      - name: Extract version from tag
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: '0'
        run: |
          PLUGIN_NAME=$(basename $(pwd))
          OUTPUT="${PLUGIN_NAME}-${{ matrix.os }}-${{ matrix.arch }}"
          go build -trimpath -ldflags="-s -w -X main.version=${{ steps.version.outputs.version }}" -o "${OUTPUT}" .

      - name: Compute SHA-256 digest
        id: digest
        run: |
          PLUGIN_NAME=$(basename $(pwd))
          BINARY="${PLUGIN_NAME}-${{ matrix.os }}-${{ matrix.arch }}"
          DIGEST="sha256:$(sha256sum "${BINARY}" | awk '{print $1}')"
          echo "digest=${DIGEST}" >> "$GITHUB_OUTPUT"
          echo "binary=${BINARY}" >> "$GITHUB_OUTPUT"

      - name: Create tar.gz archive
        run: |
          tar -czf "${{ steps.digest.outputs.binary }}.tar.gz" "${{ steps.digest.outputs.binary }}"

      - name: Sign artifact
        if: ${{ secrets.NOX_SIGNING_KEY != '' }}
        env:
          NOX_SIGNING_KEY: ${{ secrets.NOX_SIGNING_KEY }}
        run: |
          echo "${NOX_SIGNING_KEY}" | base64 -d > /tmp/signing-key.pem
          # Sign the tar.gz digest with Ed25519
          ARCHIVE="${{ steps.digest.outputs.binary }}.tar.gz"
          ARCHIVE_DIGEST="sha256:$(sha256sum "${ARCHIVE}" | awk '{print $1}')"
          echo "${ARCHIVE_DIGEST}" | openssl pkeyutl -sign -inkey /tmp/signing-key.pem -out "${ARCHIVE}.sig"
          rm -f /tmp/signing-key.pem

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            *.tar.gz
            *.tar.gz.sig

  publish:
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download all release artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: release-*
          merge-multiple: true
          path: ./dist

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ./dist/*
          generate_release_notes: true

      - name: Generate version entry fragment
        run: |
          PLUGIN_NAME=$(basename $(pwd))
          VERSION="${GITHUB_REF_NAME#v}"
          cat > version-entry.json <<EOF
          {
            "plugin": "${GITHUB_REPOSITORY}",
            "name": "${PLUGIN_NAME}",
            "version": "${VERSION}",
            "published_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "artifacts": []
          }
          EOF

      - name: Dispatch registry update
        if: ${{ secrets.REGISTRY_DISPATCH_TOKEN != '' }}
        env:
          GH_TOKEN: ${{ secrets.REGISTRY_DISPATCH_TOKEN }}
        run: |
          gh api repos/${{ inputs.registry-repo }}/dispatches \
            -f event_type=plugin-release \
            -f client_payload[version_entry]="$(cat version-entry.json)"
